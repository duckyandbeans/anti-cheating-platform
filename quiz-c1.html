<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C1 Advanced Assessment</title>
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --danger: #ef4444; --success: #10b981; --bg: #f8fafc; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: var(--bg); 
            padding: 20px; 
            color: #334155;
            -webkit-user-select: none; user-select: none;
        }
        .container { max-width: 850px; margin: 0 auto; background: white; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        
        h1 { text-align: center; color: var(--primary); margin-bottom: 0.5rem; }
        h2 { color: var(--primary); font-size: 1.25rem; margin-top: 2rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
        
        .btn { display: block; width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 20px; font-size: 1rem; transition: 0.2s; }
        .btn:hover { background: #1e293b; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        
        input, select { width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; font-size: 1rem; }
        label { font-weight: 600; display: block; margin-bottom: 5px; color: #475569; }

        /* QUIZ CARDS */
        .question-box { margin-bottom: 25px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; }
        .question-text { font-weight: 700; font-size: 1.05rem; margin-bottom: 15px; color: #1e293b; line-height: 1.6; }
        
        .mcq-label { display: flex; align-items: center; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: 0.15s; }
        .mcq-label:hover { background: #f1f5f9; border-color: var(--accent); }
        .mcq-input { margin-right: 12px; transform: scale(1.2); }
        .mcq-input:checked + span { font-weight: 700; color: var(--accent); }

        /* CLOZE PASSAGE STYLES */
        .cloze-text { background: #fffbeb; border: 1px solid #fcd34d; padding: 20px; border-radius: 8px; line-height: 1.8; font-size: 1.05rem; margin-bottom: 25px; color: #78350f; }

        /* REVIEW STYLES */
        .review-card { padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .review-correct { background-color: #ecfdf5; border-color: #10b981; }
        .review-wrong { background-color: #fef2f2; border-color: #ef4444; }
        .explanation-text { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.9rem; color: #4b5563; font-style: italic; }

        /* UTILS */
        #cheat-alert { background: #fee2e2; border: 1px solid #f87171; color: #991b1b; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; display: none; text-align: center; font-weight: bold; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .info-box { background: #e0f2fe; border: 1px solid #bae6fd; color: #0369a1; padding: 15px; border-radius: 6px; font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px; }
        .watermark-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; opacity: 0.03; display: flex; flex-wrap: wrap; overflow: hidden; }
        .watermark-text { transform: rotate(-30deg); margin: 60px; font-weight: 900; font-size: 24px; color: #000; }

        #login-section, #system-check-section, #quiz-section, #teacher-section { display: none; }
        #login-section { display: block; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body oncontextmenu="return false;">

<div id="global-watermark" class="watermark-overlay"></div>

<div class="container">
    <div id="cheat-alert">‚ö†Ô∏è ALERT: Screen switch detected!</div>

    <div id="login-section">
        <h1>C1 Advanced Exam</h1>
        <p style="text-align:center; color:#64748b; margin-bottom: 30px;">Past Tense & Narrative Structures</p>
        
        <label>Class Group</label>
        <select id="studentClass">
            <option value="">Select Class...</option>
            <option value="C1 Advanced A">C1 Advanced A</option>
            <option value="C1 Advanced B">C1 Advanced B</option>
            <option value="Private Student">Private Student</option>
        </select>

        <label>Student ID / Attendance No.</label>
        <input type="number" id="studentNo" placeholder="e.g. 101">

        <label>Full Name</label>
        <input type="text" id="studentName" placeholder="Enter your full name">

        <button class="btn" onclick="verifyLogin()">Next Step</button>
    </div>

    <div id="system-check-section">
        <h1>‚öôÔ∏è Exam Environment</h1>
        
        <div class="info-box">
            <strong>‚ö†Ô∏è SECURITY PROTOCOLS:</strong><br><br>
            1. <strong>Full Screen Required:</strong> Do not minimize or resize the browser.<br>
            2. <strong>Focus Tracking:</strong> Switching tabs is recorded as a violation.<br>
            3. <strong>Academic Integrity:</strong> This assessment measures your true proficiency level.<br>
        </div>
        
        <div style="margin-top:20px;">
            <input type="checkbox" id="rulesCheck" onchange="document.getElementById('startBtn').disabled = !this.checked">
            <label for="rulesCheck" style="display:inline; font-weight:400;">I confirm that I am ready to begin under exam conditions.</label>
            <button class="btn" id="startBtn" onclick="startQuiz()" disabled>START ASSESSMENT</button>
        </div>
    </div>

    <div id="quiz-section">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #e2e8f0; padding-bottom:15px; margin-bottom:20px;">
            <div style="font-weight:bold; color:var(--primary);">C1 Advanced</div>
            <div style="color:var(--danger); font-weight:bold; font-size:0.9rem; animation: pulse 2s infinite;">‚óè LIVE MONITORING</div>
        </div>
        
        <form id="quiz-form">
            <div id="quiz-container">Loading...</div>
        </form>

        <button class="btn" id="submitBtn" onclick="submitExam()">Submit Final Answers</button>
    </div>

    <div id="teacher-section">
        <h1>üë©‚Äçüè´ Teacher Dashboard</h1>
        <div style="text-align:center; margin-bottom:20px; color:#64748b;">Manage Results for C1 Exam</div>
        <button class="btn" onclick="downloadExcel()">üì• Download Results (.csv)</button>
        <button class="btn" onclick="location.reload()" style="background:#64748b; margin-top:10px;">Log Out</button>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG (Standard) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097"
    };
    try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){}

    // --- VARIABLES ---
    const COLLECTION_NAME = "c1_advanced_quiz_results"; 
    let currentDocID = null;
    let switchCount = 0;
    let sessionActive = false;

    // --- C1 DATA SOURCE ---
    const QUIZ_SOURCE = {
        "part_1": [
            { "id": 1, "question": "No sooner ______ the door than the phone started ringing.", "options": ["I had opened", "did I open", "had I opened", "was I opening"], "answer": "had I opened", "explain": "Inversion is required with 'No sooner... than' using Past Perfect." },
            { "id": 2, "question": "It was high time he ______ the truth about what happened that night.", "options": ["told", "had told", "was telling", "did tell"], "answer": "told", "explain": "'It's high time' is followed by Past Simple for present/future necessity." },
            { "id": 3, "question": "She acted as though she ______ the owner of the company.", "options": ["is", "was being", "were", "has been"], "answer": "were", "explain": "'As though' uses past subjunctive ('were') for unreal situations." },
            { "id": 4, "question": "We ______ to the beach, but the car broke down halfway there.", "options": ["were to have gone", "had gone", "went", "were going to go"], "answer": "were to have gone", "explain": "Perfect infinitive structure for unfulfilled past plans." },
            { "id": 5, "question": "I ______ hoping you could lend me a hand with this project.", "options": ["was", "had been", "am", "would be"], "answer": "was", "explain": "Polite request form using Past Continuous." },
            { "id": 6, "question": "Hardly had I closed my eyes ______ I began to dream.", "options": ["than", "when", "as", "that"], "answer": "when", "explain": "'Hardly/Scarcely' pairs with 'when'." },
            { "id": 7, "question": "By the time the CEO arrived, the board members ______ the merger for three hours.", "options": ["discussed", "were discussing", "had been discussing", "discussed"], "answer": "had been discussing", "explain": "Past Perfect Continuous emphasizes duration up to a past point." },
            { "id": 8, "question": "I ______ have asked him for help, but I wanted to do it on my own.", "options": ["could", "must", "will", "may"], "answer": "could", "explain": "'Could have' expresses unutilized past capability." },
            { "id": 9, "question": "If I ______ you were coming, I would have baked a cake.", "options": ["knew", "know", "had known", "was knowing"], "answer": "had known", "explain": "Third Conditional: If + Past Perfect." },
            { "id": 10, "question": "He was a man who ______ never compromise on his principles.", "options": ["would", "used to", "was used to", "had"], "answer": "would", "explain": "'Would' describes characteristic past behavior." },
            { "id": 11, "question": "Ten years ago, I ______ in London working as a barrister.", "options": ["was to be", "would be", "was", "had been"], "answer": "was", "explain": "Simple Past for a stated fact." },
            { "id": 12, "question": "She ______ the piano beautifully, but she hasn't played in years.", "options": ["used to play", "would play", "was playing", "had played"], "answer": "used to play", "explain": "'Used to' for past states/abilities. 'Would' is only for repeated actions." },
            { "id": 13, "question": "Scarcely had the match started ______ it began to pour with rain.", "options": ["than", "then", "when", "after"], "answer": "when", "explain": "'Scarcely... when'." },
            { "id": 14, "question": "I would sooner you ______ smoke in here.", "options": ["didn't", "don't", "hadn't", "wouldn't"], "answer": "didn't", "explain": "'Would sooner' + subject + Past Simple." },
            { "id": 15, "question": "Until that moment, I ______ that he was capable of such deceit.", "options": ["wasn't realizing", "didn't realize", "hadn't realized", "haven't realized"], "answer": "hadn't realized", "explain": "Realization happened up until that specific past moment." },
            { "id": 16, "question": "The original plan was that we ______ meet at the station, but he never showed up.", "options": ["will", "were to", "would", "had to"], "answer": "were to", "explain": "'Be to' implies a schedule/arrangement." },
            { "id": 17, "question": "I sat there staring at the screen. I ______ at it for hours.", "options": ["looked", "was looking", "had been looking", "have looked"], "answer": "had been looking", "explain": "Duration before a past narrative point." },
            { "id": 18, "question": "Never before ______ such a magnificent display of fireworks.", "options": ["I had seen", "had I seen", "did I see", "I saw"], "answer": "had I seen", "explain": "Inversion triggered by negative adverb 'Never before'." },
            { "id": 19, "question": "We were very lucky; we ______ have been in that plane when it crashed.", "options": ["might", "should", "must", "can"], "answer": "might", "explain": "Past possibility that didn't happen." },
            { "id": 20, "question": "I ______ thinking about calling her when she suddenly walked through the door.", "options": ["was just", "had just been", "am just", "would just be"], "answer": "had just been", "explain": "Continuous thought immediately preceding interruption." },
            { "id": 21, "question": "Did you ______ write poetry when you were younger?", "options": ["used to", "use to", "would", "accustom to"], "answer": "use to", "explain": "With 'Did', drop the 'd' -> 'use to'." },
            { "id": 22, "question": "It ______ that he found the missing document.", "options": ["was only later", "only later was", "had been only later", "was later only"], "answer": "was only later", "explain": "Cleft sentence structure for emphasis." },
            { "id": 23, "question": "They ______ always ______ about their neighbors; it was quite annoying.", "options": ["were / complaining", "had / complained", "would / complain", "did / complain"], "answer": "were / complaining", "explain": "Past Continuous with 'always' for annoying habits." },
            { "id": 24, "question": "I prefer the red dress, but I ______ the blue one because it was cheaper.", "options": ["had bought", "bought", "was buying", "have bought"], "answer": "bought", "explain": "Simple completed action." },
            { "id": 25, "question": "Suppose you ______ the lottery last night, what would you have done?", "options": ["won", "had won", "win", "were winning"], "answer": "had won", "explain": "'Suppose' acts like 'If' in conditional structures." }
        ],
        "part_2_text": "The expedition had been plagued by misfortune from the very beginning. By the time they reached the summit, the climbers (26) ______ their supplies and were dangerously exhausted. It wasn't just the physical fatigue; morale was at an all-time low. The team leader, who (27) ______ considered the most experienced among them, seemed to have lost his way. In hindsight, they realized they (28) ______ to the local guides' warnings. If they had, they might (29) ______ in such a precarious situation now. Little (30) ______ they know that the worst storm of the century was about to descend upon them.",
        "part_2_questions": [
            { "id": 26, "question": "Select the correct form for (26)", "options": ["exhausted", "had exhausted", "were exhausting", "have exhausted"], "answer": "had exhausted", "explain": "Action completed before another past event (reached)." },
            { "id": 27, "question": "Select the correct form for (27)", "options": ["was to be", "had previously been", "would be", "used to be"], "answer": "had previously been", "explain": "State leading up to the narrative time." },
            { "id": 28, "question": "Select the correct form for (28)", "options": ["should have listened", "must have listened", "were to listen", "had listened"], "answer": "should have listened", "explain": "Regret about past advice ignored." },
            { "id": 29, "question": "Select the correct form for (29)", "options": ["not be", "not have been", "have not been", "be not"], "answer": "not have been", "explain": "Mixed conditional result (state)." },
            { "id": 30, "question": "Select the correct form for (30)", "options": ["did", "do", "had", "were"], "answer": "did", "explain": "'Little did they know' - fixed narrative inversion." }
        ]
    };

    // --- LOGIC ---
    function generateWatermark() {
        const wm = document.getElementById('global-watermark');
        let html = "";
        for(let i=0; i<40; i++) html += `<div class="watermark-text">${i%2?"C1 EXAM":"SECURE"}</div>`;
        wm.innerHTML = html;
    }
    generateWatermark();

    function verifyLogin() {
        const name = document.getElementById('studentName').value;
        const no = document.getElementById('studentNo').value;
        const cls = document.getElementById('studentClass').value;
        
        // TEACHER LOGIN: Name=030, ID=0, Class=""
        if(name === "030" && no === "0" && cls === "") {
            document.getElementById('login-section').style.display='none';
            document.getElementById('teacher-section').style.display='block';
            return;
        }

        if(!name || !no || !cls) return alert("Please fill in all details.");
        
        // UNIQUE ID
        currentDocID = `${cls.replace(/\s/g,'')}_${no}_${name.replace(/\s/g,'_')}`;
        
        document.getElementById('login-section').style.display='none';
        document.getElementById('system-check-section').style.display='block';
    }

    async function startQuiz() {
        const name = document.getElementById('studentName').value;
        const no = document.getElementById('studentNo').value;
        const cls = document.getElementById('studentClass').value;
        
        await db.collection(COLLECTION_NAME).doc(currentDocID).set({
            name: name, number: no, class: cls,
            start_time: new Date().toLocaleString(),
            status: "IN_PROGRESS", cheat_count: 0
        });

        renderQuiz();
        document.getElementById('system-check-section').style.display='none';
        document.getElementById('quiz-section').style.display='block';
        document.documentElement.requestFullscreen().catch(e=>{});
        sessionActive = true;
    }

    function renderQuiz() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = "";
        
        // PART 1: MCQ
        container.innerHTML += `<h2>Part 1: Advanced Structures</h2>`;
        QUIZ_SOURCE.part_1.forEach((q, idx) => {
            let optionsHTML = "";
            q.options.forEach(opt => {
                optionsHTML += `<label class="mcq-label"><input type="radio" class="mcq-input" name="q_${q.id}" value="${opt}"><span>${opt}</span></label>`;
            });
            container.innerHTML += `<div class="question-box"><div class="question-text">${q.id}. ${q.question}</div>${optionsHTML}</div>`;
        });

        // PART 2: CLOZE
        container.innerHTML += `<h2>Part 2: Cloze Passage</h2>`;
        
        // Render Text Block
        container.innerHTML += `<div class="cloze-text"><strong>Instructions:</strong> Read the text and choose the best answer for gaps 26-30.<hr style="border-top:1px solid #fcd34d; margin:15px 0;">${QUIZ_SOURCE.part_2_text}</div>`;

        // Render Cloze Questions
        QUIZ_SOURCE.part_2_questions.forEach((q) => {
            let optionsHTML = "";
            q.options.forEach(opt => {
                optionsHTML += `<label class="mcq-label"><input type="radio" class="mcq-input" name="q_${q.id}" value="${opt}"><span>${opt}</span></label>`;
            });
            container.innerHTML += `<div class="question-box"><div class="question-text">Gap (${q.id}):</div>${optionsHTML}</div>`;
        });
    }

    async function submitExam() {
        if(!confirm("Are you sure you want to submit? This cannot be undone.")) return;
        sessionActive = false;
        
        let score = 0;
        let total = 0;
        let answers = {};
        
        // Grade Part 1
        QUIZ_SOURCE.part_1.forEach(q => {
            total++;
            const val = (document.querySelector(`input[name="q_${q.id}"]:checked`) || {}).value || "";
            answers[`Q${q.id}`] = val;
            if(val === q.answer) score++;
        });

        // Grade Part 2
        QUIZ_SOURCE.part_2_questions.forEach(q => {
            total++;
            const val = (document.querySelector(`input[name="q_${q.id}"]:checked`) || {}).value || "";
            answers[`Q${q.id}`] = val;
            if(val === q.answer) score++;
        });

        await db.collection(COLLECTION_NAME).doc(currentDocID).update({
            status: "COMPLETED", finish_time: new Date().toLocaleString(),
            score: score, total: total, all_answers: answers, final_cheat_count: switchCount
        });

        // GENERATE REPORT CARD
        let reviewHTML = "";
        
        const generateReview = (q, id) => {
            const userAns = answers[`Q${id}`];
            const isCorrect = userAns === q.answer;
            const cssClass = isCorrect ? "review-correct" : "review-wrong";
            const icon = isCorrect ? "‚úÖ" : "‚ùå";
            
            return `
                <div class="review-card ${cssClass}">
                    <div><strong>${id}. ${q.question}</strong></div>
                    <div style="margin-top:5px;">Your Answer: <strong>${userAns || "(Skipped)"}</strong> ${icon}</div>
                    ${!isCorrect ? `<div style="color:#b91c1c; font-weight:bold; font-size:0.9rem;">Correct: ${q.answer}</div>` : ""}
                    <div class="explanation-text">üí° ${q.explain}</div>
                </div>
            `;
        };

        // Review Part 1
        reviewHTML += "<h3>Part 1 Review</h3>";
        QUIZ_SOURCE.part_1.forEach(q => reviewHTML += generateReview(q, q.id));

        // Review Part 2
        reviewHTML += "<h3>Part 2 Review</h3>";
        QUIZ_SOURCE.part_2_questions.forEach(q => reviewHTML += generateReview(q, q.id));

        document.body.innerHTML = `
            <div class="container">
                <h1 style="color:var(--primary)">Assessment Complete</h1>
                <div style="background:var(--primary); color:white; padding:20px; border-radius:8px; text-align:center; margin-bottom:30px;">
                    <div style="font-size:3rem; font-weight:bold;">${score} / ${total}</div>
                    <div>Final Score</div>
                </div>
                <hr>
                ${reviewHTML}
                <button class="btn" onclick="location.reload()" style="background:#64748b;">Exit Exam</button>
            </div>
        `;
    }

    // --- ANTI-CHEAT ---
    document.addEventListener("visibilitychange", () => {
        if(document.hidden && sessionActive) {
            switchCount++;
            document.getElementById('cheat-alert').style.display='block';
            document.getElementById('cheat-alert').innerText = `‚ö†Ô∏è VIOLATION RECORDED: Tab Switch #${switchCount}`;
            db.collection(COLLECTION_NAME).doc(currentDocID).update({cheat_count: switchCount});
        }
    });

    // --- TEACHER DOWNLOAD ---
    async function downloadExcel() {
        const snap = await db.collection(COLLECTION_NAME).get();
        let csv = "data:text/csv;charset=utf-8,Class,ID,Name,Score,Total,Cheats,Answers\n";
        snap.forEach(doc => {
            const d = doc.data();
            const ansStr = JSON.stringify(d.all_answers || {}).replace(/,/g, '|').replace(/"/g,"'");
            csv += `${d.class},${d.number},"${d.name}",${d.score},${d.total},${d.cheat_count},"${ansStr}"\n`;
        });
        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = "C1_Exam_Results.csv";
        document.body.appendChild(link);
        link.click();
    }
</script>
</body>
</html>
