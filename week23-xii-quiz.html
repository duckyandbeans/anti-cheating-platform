<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week 23: Critical Thinking Assessment</title>
    <style>
        :root {
            --primary: #1e1e24;
            --accent: #c44569;
            --bg: #f7f1e3;
            --paper: #ffffff;
            --text: #2f3542;
            --danger: #ff4757;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            user-select: none;
        }

        /* --- LOGIN --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 8px; width: 90%; max-width: 400px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        select, input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        button.btn {
            width: 100%; padding: 12px; background: var(--accent); color: white;
            border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
            font-size: 1rem; transition: 0.2s;
        }
        button.btn:hover { background: #b03a5b; }

        /* --- MAIN INTERFACE --- */
        #main-content { display: none; max-width: 900px; margin: 0 auto; }

        /* TIMER & HEADER */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--primary); color: white; padding: 15px 25px;
            border-radius: 8px 8px 0 0; margin-bottom: 0;
        }
        .timer-box {
            font-family: 'Courier New', monospace; font-size: 1.5rem; font-weight: bold;
            color: var(--danger); background: #000; padding: 5px 15px; border-radius: 4px;
        }

        /* CASE FILE */
        .case-file {
            background: white; padding: 30px; border-radius: 0 0 8px 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .evidence-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;
        }
        @media (max-width: 700px) { .evidence-grid { grid-template-columns: 1fr; } }

        .evidence-card {
            background: #f1f2f6; padding: 20px; border-left: 5px solid var(--primary);
            border-radius: 4px;
        }
        .evidence-card h3 { margin-top: 0; color: var(--accent); font-size: 1.1rem; }
        .quote { font-style: italic; color: #57606f; margin-top: 10px; display: block; }

        /* INPUT AREA */
        .report-section {
            background: #dfe4ea; padding: 25px; border-radius: 8px; margin-top: 20px;
            border: 2px dashed #a4b0be;
        }
        textarea {
            width: 100%; height: 200px; padding: 15px; border: 1px solid #ced6e0;
            border-radius: 6px; font-family: 'Segoe UI', sans-serif; font-size: 1rem;
            resize: vertical; margin-top: 10px;
        }

        /* ANTI-CHEAT UI */
        #cheat-alert {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(220, 38, 38, 0.98); color: white; z-index: 20000;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; text-align: center;
        }
        #cheat-counter {
            background: white; color: var(--danger); padding: 5px 15px; border-radius: 20px;
            font-weight: bold; font-size: 0.9rem;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body oncontextmenu="return false;">

    <div id="cheat-alert">
        <div style="font-size: 5rem;">üö´</div>
        <h1>TEST LOCKED</h1>
        <p>You left the active window. This incident has been logged.</p>
        <button onclick="dismissCheatAlert()" class="btn" style="width: auto; background: white; color: red; margin-top: 20px;">Resume Test</button>
    </div>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--primary)">üïµÔ∏è Critical Thinking Assessment</h2>
            <p style="color:#666; font-size:0.9rem;">Duration: 15 Minutes</p>
            <select id="sClass">
                <option value="">Select Class...</option>
                <option value="XII D">XII D</option>
                <option value="XII E">XII E</option>
                <option value="XII H">XII H</option>
                <option value="XII I">XII I</option>
            </select>
            <input type="number" id="sNo" placeholder="Attendance Number">
            <input type="text" id="sName" placeholder="Full Name">
            <button class="btn" onclick="attemptLogin()">Start Investigation</button>
        </div>
    </div>

    <div id="main-content">
        <div class="top-bar">
            <div>
                <strong>Case #9021: The Server Breach</strong>
                <span id="cheat-counter" style="margin-left: 15px;">Offenses: 0</span>
            </div>
            <div class="timer-box" id="timer">15:00</div>
        </div>

        <div class="case-file">
            <h2>The Scenario</h2>
            <p><strong>Incident:</strong> At 10:00 PM last night, the school server was hacked. Only 4 people were in the building. One of them is lying. Use their statements to deduce the culprit.</p>
            
            <div class="evidence-grid">
                <div class="evidence-card">
                    <h3>üë§ Mr. White (Janitor)</h3>
                    <span class="quote">"I was mopping the hallway from 9:30 PM to 10:15 PM. I saw Mrs. Green enter the server room at 9:55 PM."</span>
                </div>
                <div class="evidence-card">
                    <h3>üë§ Mrs. Green (Teacher)</h3>
                    <span class="quote">"That's impossible. I had already left the building by 9:45 PM. I was driving home when the hack happened."</span>
                </div>
                <div class="evidence-card">
                    <h3>üë§ Mr. Blue (IT Tech)</h3>
                    <span class="quote">"I was in the cafeteria drinking coffee. I saw Mr. White mopping the hallway at 10:05 PM."</span>
                </div>
                <div class="evidence-card">
                    <h3>üë§ Ms. Scarlet (Principal)</h3>
                    <span class="quote">"I was in my office. The security logs show that the server room door was opened with Mrs. Green's ID card at 10:00 PM."</span>
                </div>
            </div>

            <div class="report-section">
                <h3>üìù Detective's Final Report</h3>
                <p style="font-size:0.9rem; color:#555;">
                    <strong>Requirement:</strong> Write a paragraph (min. 50 words) identifying the liar. You MUST use <strong>Reported Speech</strong> (e.g., "He claimed that...") and <strong>Past Perfect Tense</strong> (e.g., "She had already left...") to explain the contradiction in the timeline.
                </p>
                <textarea id="essayInput" placeholder="Start your report here..."></textarea>
                <button class="btn" onclick="submitWork()" style="margin-top: 15px;">Submit Final Report</button>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
          authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
          projectId: "anti-cheating-remedial-quiz",
          storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
          messagingSenderId: "979294386230",
          appId: "1:979294386230:web:7f9ff3e377d4da20cd4097"
        };
        try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){}

        const COLLECTION_NAME = "week23xii_critical";
        let cheatCount = 0;
        let sessionActive = false;
        let wakeLock = null;
        let currentDocID = null;
        let timeLeft = 900; // 15 Minutes in seconds
        let timerInterval;

        // --- LOGIN LOGIC ---
        async function attemptLogin() {
            const cls = document.getElementById('sClass').value;
            const no = document.getElementById('sNo').value;
            const name = document.getElementById('sName').value;

            if (!cls || !no || !name) { alert("Fill all fields."); return; }

            currentDocID = `${cls.replace(/\s/g,'')}_${no}_${name.replace(/\s/g,'_')}`;
            
            // Create Session
            await db.collection(COLLECTION_NAME).doc(currentDocID).set({
                name: name, class: cls, number: no,
                start_time: new Date().toLocaleString(),
                status: "THINKING", cheat_count: 0
            }, { merge: true });

            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            // Start Systems
            requestWakeLock();
            setTimeout(() => { sessionActive = true; }, 2000); 
            document.documentElement.requestFullscreen().catch(e=>{});
            startTimer();
        }

        // --- TIMER LOGIC ---
        function startTimer() {
            timerInterval = setInterval(() => {
                if(timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("Time's up! Submitting automatically.");
                    submitWork(true);
                } else {
                    timeLeft--;
                    const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                    const s = (timeLeft % 60).toString().padStart(2, '0');
                    document.getElementById('timer').innerText = `${m}:${s}`;
                    
                    // Visual Warning
                    if(timeLeft < 60) document.getElementById('timer').style.color = "yellow";
                }
            }, 1000);
        }

        // --- SUBMIT LOGIC ---
        async function submitWork(auto = false) {
            const essay = document.getElementById('essayInput').value;
            
            if(!auto) {
                if (essay.split(" ").length < 10) return alert("Your report is too short. Explain your reasoning.");
                if (!confirm("Submit Final Report? You cannot edit this later.")) return;
            }

            sessionActive = false;
            clearInterval(timerInterval);

            await db.collection(COLLECTION_NAME).doc(currentDocID).update({
                status: "COMPLETED",
                finish_time: new Date().toLocaleString(),
                essay_answer: essay,
                final_cheat_count: cheatCount,
                time_remaining: timeLeft
            });

            document.body.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; height:100vh; background:#f7f1e3; flex-direction:column; text-align:center;">
                    <h1 style="color:#1e1e24; font-size:3rem;">Case Closed üïµÔ∏è</h1>
                    <p style="font-size:1.2rem; color:#555;">Your report has been filed.</p>
                </div>
            `;
        }

        // --- WAKE LOCK ---
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                document.addEventListener('visibilitychange', async () => {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        wakeLock = await navigator.wakeLock.request('screen');
                    }
                });
            } catch (err) { console.error(err); }
        }

        // --- ANTI-CHEAT ---
        function triggerCheat() {
            if (!sessionActive) return;
            
            cheatCount++;
            document.getElementById('cheat-counter').innerText = `OFFENSES: ${cheatCount}`;
            document.getElementById('cheat-alert').style.display = 'flex';
            
            if(currentDocID) {
                db.collection(COLLECTION_NAME).doc(currentDocID).update({ cheat_count: cheatCount });
            }
        }

        function dismissCheatAlert() {
            document.getElementById('cheat-alert').style.display = 'none';
        }

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'hidden') triggerCheat();
        });

        window.addEventListener("blur", () => {
            triggerCheat();
        });

    </script>
</body>
</html>
