<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restricted Exam Materials</title>
    <style>
        :root { --primary: #4f46e5; --danger: #ef4444; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #1f2937; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #111827; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        
        .btn { display: block; width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1rem;}
        .btn:hover { background: #4338ca; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .btn-finish { background: #10b981; }
        .btn-finish:hover { background: #059669; }

        .btn-download { background: #0ea5e9; } /* Blue for download */
        .btn-download:hover { background: #0284c7; }

        /* IMAGE GALLERY */
        .image-gallery { display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .image-gallery img { width: 100%; max-width: 800px; border: 2px solid #e5e7eb; border-radius: 8px; }

        /* WARNING BOX */
        #cheat-alert { 
            background: #fee2e2; border: 1px solid #f87171; color: #991b1b; 
            padding: 1rem; border-radius: 8px; margin-bottom: 2rem; 
            display: none; text-align: center; font-weight: bold; 
            position: sticky; top: 10px; z-index: 100;
        }

        /* SECTIONS */
        #login-section { display: block; }
        #content-section { display: none; }
        #teacher-section { display: none; }

        .error-msg { color: var(--danger); text-align: center; display:none; margin-top: 10px; font-weight: bold; padding: 10px; background: #fee2e2; border-radius: 4px;}
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
    <div id="cheat-alert">‚ö†Ô∏è ALERT: Screen switch detected! Recording incident...</div>

    <div id="login-section">
        <h1>Material Access Login</h1>
        <p style="text-align:center; color:#666;">One-time access only. Do not reload.</p>
        <hr>
        
        <div class="form-group">
            <label>Class</label>
            <select id="studentClass">
                <option value="">Select Class...</option>
                <option value="XI D">XI D</option>
                <option value="XI E">XI E</option>
                <option value="XI H">XI H</option>
                <option value="XI I">XI I</option>
                <option value="XII H">XII H</option>
                <option value="XII I">XII I</option>
            </select>
        </div>
        <div class="form-group">
            <label>Student Number</label>
            <input type="number" id="studentNo" placeholder="e.g. 15">
        </div>
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="studentName" placeholder="Enter your full name">
        </div>
        
        <button class="btn" id="startBtn" onclick="startSession()">Start Exam View</button>
        <p class="error-msg" id="login-error"></p>
    </div>

    <div id="content-section">
        <h2 style="text-align:center;">Exam Materials</h2>
        <div style="text-align:center; margin-bottom:20px; color:#ef4444; font-weight:bold;">
            DO NOT SWITCH TABS.
        </div>

        <div class="image-gallery">
            <img src="1.png" alt="Page 1">
            <img src="2.png" alt="Page 2">
            <img src="3.png" alt="Page 3">
        </div>

        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;">
            <button class="btn btn-finish" id="finishBtn" onclick="finishSession()">I'M DONE (SUBMIT)</button>
        </div>
    </div>

    <div id="teacher-section" style="text-align: center;">
        <h1 style="color: var(--primary);">üë©‚Äçüè´ Teacher Dashboard</h1>
        <p>Manage exam submissions and download reports.</p>
        <hr>
        
        <div style="margin: 40px 0;">
            <button class="btn btn-download" onclick="downloadExcel()">üì• Download Student Report (.csv)</button>
        </div>

        <p id="download-status" style="color: #666; font-size: 0.9rem;"></p>
        
        <div style="margin-top: 40px; border-top: 1px solid #eee; padding-top:20px;">
            <button class="btn" onclick="location.reload()" style="background:#666;">Log Out</button>
        </div>
    </div>
</div>

<script>
    // 1. CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097",
      measurementId: "G-84YB5CYGM8"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch (e) {
        alert("Database Error: " + e.message);
    }

    // 2. STATE VARIABLES
    let switchCount = 0;
    let evidenceLogs = [];
    let sessionActive = false;
    let currentDocID = null; 

    // 3. TRAP LOGIC
    function logCheat(reason) {
        if (!sessionActive) return;

        const now = new Date();
        const timeString = now.toLocaleTimeString();
        switchCount++;
        evidenceLogs.push(`[${reason} at ${timeString}]`);

        // Update UI
        const alertBox = document.getElementById('cheat-alert');
        alertBox.style.display = 'block';
        alertBox.innerText = `‚ö†Ô∏è WARNING: Screen switch detected (${switchCount})! Recorded.`;

        // Update DB Immediately
        if (currentDocID) {
            db.collection("exam_access_logs").doc(currentDocID).update({
                cheat_count: switchCount,
                evidence_logs: evidenceLogs.join(" | ")
            });
        }
    }

    document.addEventListener("visibilitychange", () => {
        if (document.hidden) logCheat("Tab Switched");
    });
    window.addEventListener("blur", () => {
        logCheat("Window Blurred");
    });

    // 4. START SESSION (Unified Login)
    async function startSession() {
        const cls = document.getElementById('studentClass').value;
        const no = document.getElementById('studentNo').value;
        const name = document.getElementById('studentName').value;
        const btn = document.getElementById('startBtn');
        const err = document.getElementById('login-error');

        // Reset Error
        err.style.display = 'none';

        if (!cls || !no || !name) {
            err.innerText = "Please fill in all details.";
            err.style.display = "block";
            return;
        }

        // --- CHECK FOR TEACHER LOGIN ---
        if (cls === "XI D" && no === "0" && name === "030") {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('teacher-section').style.display = 'block';
            return; // Stop here, don't run student logic
        }
        // -------------------------------

        btn.disabled = true;
        btn.innerText = "Verifying...";

        // Create Unique ID (Class + Number)
        const uniqueID = `${cls}_${no}`;
        currentDocID = uniqueID;

        try {
            // A. Check if user already exists
            const docSnap = await db.collection("exam_access_logs").doc(uniqueID).get();

            if (docSnap.exists) {
                const data = docSnap.data();
                btn.innerText = "Access Denied";
                err.innerHTML = `‚õî ACCESS DENIED.<br>Student ${cls}-${no} has already accessed this exam.<br>First Login: ${data.start_time}`;
                err.style.display = 'block';
                return;
            }

            // B. If new, create the document
            await db.collection("exam_access_logs").doc(uniqueID).set({
                class: cls,
                number: no,
                name: name,
                start_time: new Date().toLocaleString(),
                finish_time: "Not Finished",
                status: "IN_PROGRESS",
                cheat_count: 0,
                evidence_logs: ""
            });

            // C. Start Exam
            sessionActive = true;
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('content-section').style.display = 'block';
            
            // Attempt Fullscreen
            document.documentElement.requestFullscreen().catch(e => {});

        } catch (e) {
            console.error(e);
            err.innerText = "System Error: " + e.message;
            err.style.display = 'block';
            btn.disabled = false;
        }
    }

    // 5. FINISH SESSION
    async function finishSession() {
        if (!confirm("Are you sure you are done? This will lock your submission.")) return;

        const btn = document.getElementById('finishBtn');
        btn.disabled = true;
        btn.innerText = "Saving...";
        sessionActive = false;

        try {
            if (currentDocID) {
                await db.collection("exam_access_logs").doc(currentDocID).update({
                    status: "COMPLETED",
                    finish_time: new Date().toLocaleString(),
                    final_cheat_count: switchCount
                });
            }

            document.body.innerHTML = `
                <div class="container" style="text-align:center">
                    <h1 style="color:green">Submission Saved</h1>
                    <p>Name: ${document.getElementById('studentName').value}</p>
                    <p>Finish Time: ${new Date().toLocaleTimeString()}</p>
                    <p style="color:#666; font-size:0.9rem;">You may close this tab.</p>
                    <p> All the best! We will have a grammar and vocabulary test in our next meeting Ÿ©(Àä·óúÀã*)Ÿà ‚ô° </p>
                </div>
            `;
        } catch (e) {
            alert("Error saving: " + e.message);
            btn.disabled = false;
        }
    }

    // 6. TEACHER EXCEL DOWNLOAD LOGIC
    async function downloadExcel() {
        const statusMsg = document.getElementById('download-status');
        statusMsg.innerText = "Fetching data from database...";

        try {
            const snapshot = await db.collection("exam_access_logs").get();
            
            // CSV Header
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Class,Number,Name,Status,Start Time,Finish Time,Cheat Count,Cheat Logs\n";

            snapshot.forEach(doc => {
                const d = doc.data();
                // Clean strings to prevent CSV breaking
                const cleanLogs = (d.evidence_logs || "").replace(/,/g, " | ").replace(/\n/g, " ");
                const row = `${d.class},${d.number},"${d.name}",${d.status},"${d.start_time}","${d.finish_time}",${d.cheat_count},"${cleanLogs}"`;
                csvContent += row + "\n";
            });

            // Trigger Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Exam_Cheating_Report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            statusMsg.innerText = "‚úÖ Download Complete! Check your downloads folder.";
        } catch (e) {
            statusMsg.innerText = "‚ùå Download failed: " + e.message;
        }
    }
</script>
</body>
</html>
