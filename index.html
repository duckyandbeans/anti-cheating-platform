<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Exam Portal + Essay Scan</title>
    <style>
        :root { --primary: #4f46e5; --danger: #ef4444; --bg: #f3f4f6; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            padding: 20px; 
            color: #1f2937;
            -webkit-user-select: none; 
            -moz-user-select: none; 
            user-select: none; 
        }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #111827; font-size: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        
        .btn { display: block; width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1rem;}
        .btn:hover { background: #4338ca; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-finish { background: #10b981; }
        .btn-finish:hover { background: #059669; }

        /* CAMERA STYLES */
        .camera-box {
            width: 100%; max-width: 400px; margin: 0 auto;
            border: 2px solid #333; border-radius: 8px; overflow: hidden;
            background: #000; position: relative;
        }
        video { width: 100%; height: auto; display: block; }
        canvas { display: none; }
        
        /* PHOTO PREVIEWS */
        .photo-grid { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 15px; }
        .snapshot-preview { 
            width: 100px; height: 140px; object-fit: cover; 
            border: 2px solid #10b981; border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* WATERMARK */
        .image-wrapper { position: relative; display: inline-block; width: 100%; margin-bottom: 20px; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
        .image-wrapper img { width: 100%; display: block; pointer-events: none; }
        .watermark-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-wrap: wrap; justify-content: center; align-content: center; opacity: 0.12; pointer-events: none; overflow: hidden; z-index: 10; }
        .watermark-text { transform: rotate(-30deg); font-size: 16px; font-weight: 800; color: #000; margin: 25px; white-space: nowrap; text-transform: uppercase; }

        #cheat-alert { background: #fee2e2; border: 1px solid #f87171; color: #991b1b; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; display: none; text-align: center; font-weight: bold; position: sticky; top: 10px; z-index: 100; }

        /* SECTIONS */
        #login-section { display: block; }
        #system-check-section { display: none; }
        #content-section { display: none; }
        #submission-section { display: none; } /* NEW */
        #teacher-section { display: none; }

        .error-msg { color: var(--danger); text-align: center; display:none; margin-top: 10px; font-weight: bold; padding: 10px; background: #fee2e2; border-radius: 4px;}
        .info-box { background: #e0f2fe; border: 1px solid #bae6fd; color: #0369a1; padding: 15px; border-radius: 6px; font-size: 0.9rem; line-height: 1.5; }

        /* TEACHER GRID */
        .student-card { background: #f9fafb; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; }
        .student-header { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .student-header img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; border: 2px solid #4f46e5; }
        .essay-gallery { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .essay-thumb { height: 100px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; transition: transform 0.2s; }
        .essay-thumb:hover { transform: scale(1.05); }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body oncontextmenu="return false;">

<div class="container">
    <div id="cheat-alert">‚ö†Ô∏è ALERT: Screen switch detected! Recording incident...</div>

    <div id="login-section">
        <h1>Exam Login</h1>
        <p style="text-align:center; color:#666;">Enter credentials to proceed.</p>
        <hr>
        <div class="form-group">
            <label>Class</label>
            <select id="studentClass">
                <option value="">Select Class...</option>
                <option value="XI D">XI D</option>
                <option value="XI E">XI E</option>
                <option value="XI H">XI H</option>
                <option value="XI I">XI I</option>
                <option value="XII H">XII H</option>
                <option value="XII I">XII I</option>
            </select>
        </div>
        <div class="form-group">
            <label>Student Number</label>
            <input type="number" id="studentNo" placeholder="e.g. 15">
        </div>
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="studentName" placeholder="Enter your full name">
        </div>
        <button class="btn" id="loginBtn" onclick="verifyLogin()">Next Step</button>
        <p class="error-msg" id="login-error"></p>
    </div>

    <div id="system-check-section">
        <h1>üì∏ Identity Verification</h1>
        <div class="info-box" style="margin-bottom: 20px;">
            Please take a clear selfie to verify it is you.
        </div>
        <div class="camera-box">
            <video id="videoFeed" autoplay playsinline></video>
        </div>
        <div id="id-preview-container" style="text-align:center; display:none;">
            <img id="photoPreview" class="snapshot-preview" style="display:inline-block; width:150px; height:150px;" alt="My Selfie">
        </div>
        <canvas id="canvas"></canvas>

        <button class="btn" id="snapBtn" onclick="takeIdSnapshot()" style="background:#4b5563;">üì∑ Snap Photo</button>
        
        <div id="confirmationBox" style="display:none; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            <input type="checkbox" id="confirmCheck" onchange="toggleStartBtn()">
            <label for="confirmCheck" style="display:inline; margin-left: 8px; font-size: 0.9rem;">
                I am ready. I understand leaving the screen is cheating.
            </label>
            <button class="btn" id="startBtn" onclick="startExamSession()" disabled>START EXAM</button>
        </div>
    </div>

    <div id="content-section">
        <h2 style="text-align:center;">Exam Materials</h2>
        <div style="text-align:center; margin-bottom:20px; color:#ef4444; font-weight:bold; font-size: 0.9rem;">
            Monitoring Active. Do not leave this screen.
        </div>
        <div id="gallery"></div>
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;">
            <button class="btn btn-finish" id="finishBtn" onclick="goToSubmission()">I'M DONE (SCAN ESSAY)</button>
        </div>
    </div>

    <div id="submission-section">
        <h1>üìù Scan Your Essay</h1>
        <div class="info-box">
            <strong>Instructions:</strong><br>
            1. Use the camera to take a clear photo of your handwritten pages.<br>
            2. Make sure the text is readable.<br>
            3. Click "Submit All" when finished.
        </div>
        
        <div class="camera-box" style="margin-top:20px;">
            <video id="essayVideoFeed" autoplay playsinline></video>
        </div>
        
        <button class="btn" onclick="takeEssayPhoto()" style="background:#4b5563;">üì∑ Capture Page</button>
        
        <div class="photo-grid" id="essay-grid"></div>
        <p id="photo-count" style="text-align:center; color:#666; margin-top:10px;">0 Pages Scanned</p>

        <button class="btn btn-finish" id="finalSubmitBtn" onclick="submitFinal()" disabled>Submit All & Finish</button>
    </div>

    <div id="teacher-section" style="text-align: center;">
        <h1 style="color: var(--primary);">üë©‚Äçüè´ Teacher Dashboard</h1>
        
        <div style="display: flex; gap: 10px; justify-content: center; margin: 30px 0;">
            <button class="btn btn-download" style="width: auto; margin:0;" onclick="downloadExcel()">üì• Download CSV</button>
            <button class="btn" style="width: auto; margin:0; background:#6366f1;" onclick="loadSubmissions()">üì∏ View Essays</button>
        </div>
        
        <p id="teacher-status" style="color: #666; font-size: 0.9rem;"></p>
        
        <div id="student-list" style="margin-top: 20px; max-height: 600px; overflow-y: auto;"></div>

        <button class="btn" onclick="location.reload()" style="background:#666; margin-top:30px;">Log Out</button>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097",
      measurementId: "G-84YB5CYGM8"
    };

    let db;
    try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); } 
    catch (e) { alert("Database Error"); }

    // --- VARIABLES ---
    let switchCount = 0;
    let evidenceLogs = [];
    let sessionActive = false;
    let currentDocID = null; 
    let idPhotoData = ""; 
    let essayPhotos = []; // Array to store essay pages

    // --- 1. LOGIN ---
    async function verifyLogin() {
        const cls = document.getElementById('studentClass').value;
        const no = document.getElementById('studentNo').value;
        const name = document.getElementById('studentName').value;
        const err = document.getElementById('login-error');

        if (!cls || !no || !name) return err.innerText = "Fill all details", err.style.display = "block";

        if (cls === "XI D" && no === "0" && name === "030") {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('teacher-section').style.display = 'block';
            return;
        }

        document.getElementById('loginBtn').innerText = "Checking...";
        const uniqueID = `${cls}_${no}`;
        currentDocID = uniqueID;

        try {
            const docSnap = await db.collection("exam_access_logs").doc(uniqueID).get();
            if (docSnap.exists) {
                document.getElementById('loginBtn').innerText = "Denied";
                err.innerText = "Access Denied: Already Logged In";
                err.style.display = 'block';
                return;
            }
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('system-check-section').style.display = 'block';
            startCamera('videoFeed'); 
        } catch (e) { alert("Error: " + e.message); }
    }

    // --- 2. CAMERA HELPERS ---
    function startCamera(videoElementId) {
        const video = document.getElementById(videoElementId);
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }) // Try rear camera for essay
            .then(s => video.srcObject = s)
            .catch(e => {
                // Fallback to user facing if environment fails
                navigator.mediaDevices.getUserMedia({ video: true }).then(s => video.srcObject = s);
            });
        }
    }

    // Capture Selfie
    function takeIdSnapshot() {
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Scale down for DB storage
        const scale = 300 / video.videoWidth;
        canvas.width = 300;
        canvas.height = video.videoHeight * scale;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        idPhotoData = canvas.toDataURL('image/jpeg', 0.5);

        document.getElementById('photoPreview').src = idPhotoData;
        document.getElementById('id-preview-container').style.display = 'block';
        video.style.display = 'none';
        document.getElementById('snapBtn').style.display = 'none';
        document.getElementById('confirmationBox').style.display = 'block';
    }

    // Capture Essay Page
    function takeEssayPhoto() {
        const video = document.getElementById('essayVideoFeed');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Keep resolution decent for reading (800px width)
        const scale = 800 / video.videoWidth;
        canvas.width = 800;
        canvas.height = video.videoHeight * scale;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Compress (0.6 quality)
        const photoData = canvas.toDataURL('image/jpeg', 0.6);
        essayPhotos.push(photoData);

        // Update UI
        const img = document.createElement('img');
        img.src = photoData;
        img.className = 'snapshot-preview';
        document.getElementById('essay-grid').appendChild(img);
        
        document.getElementById('photo-count').innerText = `${essayPhotos.length} Pages Scanned`;
        document.getElementById('finalSubmitBtn').disabled = false;
        document.getElementById('finalSubmitBtn').innerText = `Submit ${essayPhotos.length} Pages`;
    }

    function toggleStartBtn() {
        document.getElementById('startBtn').disabled = !document.getElementById('confirmCheck').checked;
    }

    // --- 3. START EXAM ---
    async function startExamSession() {
        const cls = document.getElementById('studentClass').value;
        const no = document.getElementById('studentNo').value;
        const name = document.getElementById('studentName').value;

        await db.collection("exam_access_logs").doc(currentDocID).set({
            class: cls, number: no, name: name, photo: idPhotoData,
            start_time: new Date().toLocaleString(),
            finish_time: "Not Finished", status: "IN_PROGRESS",
            cheat_count: 0, evidence_logs: "", essay_pages: []
        });

        // Watermarks
        const gallery = document.getElementById('gallery');
        ['1.png', '2.png', '3.png'].forEach(imgSrc => {
            const div = document.createElement('div');
            div.className = 'image-wrapper';
            let wm = "";
            for(let i=0; i<25; i++) wm += `<div class="watermark-text">${i%2===0?"DO NOT CHEAT":"HONESTY IS INTEGRITY"}</div>`;
            div.innerHTML = `<div class="watermark-overlay">${wm}</div><img src="${imgSrc}">`;
            gallery.appendChild(div);
        });

        sessionActive = true;
        document.getElementById('system-check-section').style.display = 'none';
        document.getElementById('content-section').style.display = 'block';
        document.documentElement.requestFullscreen().catch(e => {});
    }

    // --- 4. TRAP LOGIC ---
    document.addEventListener("visibilitychange", () => { if (document.hidden) logCheat("Tab Switched"); });
    window.addEventListener("blur", () => { logCheat("Window Blurred"); });

    function logCheat(reason) {
        if (!sessionActive) return;
        switchCount++;
        const now = new Date().toLocaleTimeString();
        evidenceLogs.push(`[${reason} at ${now}]`);
        document.getElementById('cheat-alert').style.display = 'block';
        document.getElementById('cheat-alert').innerText = `‚ö†Ô∏è WARNING: Screen switch detected (${switchCount})!`;
        if (currentDocID) db.collection("exam_access_logs").doc(currentDocID).update({ cheat_count: switchCount, evidence_logs: evidenceLogs.join(" | ") });
    }

    // --- 5. SUBMISSION FLOW ---
    function goToSubmission() {
        if (!confirm("Are you finished viewing the questions? You will now scan your essay.")) return;
        
        // Pause monitoring briefly so they can use camera without flagging "Cheat"
        sessionActive = false; 
        
        document.getElementById('content-section').style.display = 'none';
        document.getElementById('submission-section').style.display = 'block';
        startCamera('essayVideoFeed');
    }

    async function submitFinal() {
        if (!confirm("Submit all pages and finish?")) return;
        
        const btn = document.getElementById('finalSubmitBtn');
        btn.disabled = true;
        btn.innerText = "Uploading...";

        try {
            await db.collection("exam_access_logs").doc(currentDocID).update({
                status: "COMPLETED",
                finish_time: new Date().toLocaleString(),
                essay_pages: essayPhotos
            });
            document.body.innerHTML = `<div class="container" style="text-align:center"><h1 style="color:green">Submitted Successfully!</h1><p>You may close this tab. We are going to have a grammar and vocab test next meeting Ÿ©(Àä·óúÀã*)Ÿà ‚ô°</p></div>`;
        } catch(e) {
            alert("Upload failed. Try again.");
            btn.disabled = false;
        }
    }
// HELPER: Opens Base64 images safely in a new window
function openViewer(base64Data) {
    const win = window.open();
    if (win) {
        win.document.write(`
            <html>
                <head><title>Image Viewer</title></head>
                <body style="margin:0; background:#222; display:flex; justify-content:center; align-items:center; height:100vh;">
                    <img src="${base64Data}" style="max-width:100%; max-height:100vh; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
                </body>
            </html>
        `);
    } else {
        alert("Please allow popups to view the image.");
    }
}
    // --- 6. TEACHER DASHBOARD ---
    async function loadSubmissions() {
    const list = document.getElementById('student-list');
    const status = document.getElementById('teacher-status');
    list.innerHTML = "";
    status.innerText = "Loading data...";

    const snap = await db.collection("exam_access_logs").orderBy("start_time", "desc").get();
    
    if(snap.empty) { 
        status.innerText = "No students found."; 
        return; 
    }

    snap.forEach(doc => {
        const d = doc.data();
        const div = document.createElement('div');
        div.className = 'student-card';
        
        // 1. Prepare Essay Thumbnails (Using the new openViewer fix)
        let essayHTML = "";
        if(d.essay_pages && d.essay_pages.length > 0) {
            d.essay_pages.forEach((src, index) => {
                // We pass the image data to the new function on click
                essayHTML += `
                    <div style="text-align:center; min-width:80px;">
                        <img src="${src}" class="essay-thumb" onclick="openViewer('${src}')">
                        <div style="font-size:10px; color:#666; margin-top:4px;">Page ${index + 1}</div>
                    </div>
                `;
            });
        } else {
            essayHTML = "<span style='color:red; font-size:0.9rem;'>No Essay Scanned</span>";
        }

        // 2. Prepare Cheat Badge
        const badge = d.cheat_count > 0 
            ? `<span style="background:#fee2e2; color:red; padding:2px 6px; border-radius:4px; font-weight:bold;">‚ö†Ô∏è ${d.cheat_count} Cheats</span>` 
            : `<span style="color:green; font-weight:bold;">‚úÖ Clean</span>`;

        // 3. Render Card
        div.innerHTML = `
            <div class="student-header">
                <img src="${d.photo || 'https://via.placeholder.com/60'}" alt="Selfie" onclick="openViewer(this.src)" style="cursor:pointer;">
                <div>
                    <div style="font-weight:bold; font-size:1.1rem;">${d.class} - ${d.name} <span style="font-size:0.8rem; color:#999;">(#${d.number})</span></div>
                    <div style="font-size:0.9rem; color:#555;">Status: ${d.status} | ${badge}</div>
                    <div style="font-size:0.8rem; color:#888;">Start: ${d.start_time || '-'} | Finish: ${d.finish_time || '-'}</div>
                </div>
            </div>
            <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                <strong style="font-size:0.9rem; color:#333;">Essay Pages (Click to View):</strong><br>
                <div class="essay-gallery" style="margin-top:5px;">${essayHTML}</div>
            </div>
        `;
        list.appendChild(div);
    });
    status.innerText = `Showing ${snap.size} submissions.`;
}
    async function downloadExcel() {
        const status = document.getElementById('teacher-status');
        status.innerText = "Generating CSV...";
        const snap = await db.collection("exam_access_logs").get();
        let csv = "data:text/csv;charset=utf-8,Class,Number,Name,Status,Start,Finish,Cheats,Logs\n";
        snap.forEach(doc => {
            const d = doc.data();
            csv += `${d.class},${d.number},"${d.name}",${d.status},"${d.start_time}","${d.finish_time}",${d.cheat_count},"${(d.evidence_logs||"").replace(/\n/g," ")}"\n`;
        });
        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = "Exam_Report.csv";
        document.body.appendChild(link);
        link.click();
        status.innerText = "Download Complete.";
    }
</script>
</body>
</html>
