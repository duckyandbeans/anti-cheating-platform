<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Materials - Secure View</title>
    <style>
        :root {
            --primary: #4f46e5;
            --danger: #ef4444;
            --bg: #f3f4f6;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: #1f2937; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        h1 { text-align: center; color: #111827; margin-bottom: 0.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; }
        
        .btn { display: block; width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .btn:hover { background: #4338ca; }

        /* IMAGE GALLERY STYLES */
        .exam-image {
            width: 100%;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #cheat-alert { 
            background: #fee2e2; 
            border: 1px solid #f87171; 
            color: #991b1b; 
            padding: 1rem; 
            border-radius: 8px; 
            margin-bottom: 2rem; 
            display: none; 
            text-align: center; 
            font-weight: bold; 
            animation: pulse 2s infinite; 
        }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        #exam-section { display: none; }
        .error-msg { color: var(--danger); font-weight: bold; text-align: center; margin-top: 10px; display:none; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
    <div id="cheat-alert">⚠️ ALERT: You switched tabs! This has been recorded.</div>

    <div id="login-section">
        <h1>SECURE EXAM MATERIALS</h1>
        <p style="text-align:center; color:#6b7280;">Login to access the diagrams.</p>
        <hr style="margin-bottom: 2rem;">
        
        <div class="form-group">
            <label>Class</label>
            <select id="studentClass">
                <option value="">Select Class...</option>
                <option value="XI D">XI D</option>
                <option value="XI E">XI E</option>
                <option value="XI H">XI H</option>
                <option value="XI I">XI I</option>
                <option value="XII H">XII H</option>
                <option value="XII I">XII I</option>
            </select>
        </div>
        <div class="form-group">
            <label>Student Number</label>
            <input type="number" id="studentNo" placeholder="e.g. 15">
        </div>
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="studentName" placeholder="Enter your full name">
        </div>
        
        <button class="btn" id="startBtn" onclick="startExam()">View Materials</button>
        <p class="error-msg" id="login-error"></p>
    </div>

    <div id="exam-section">
        <h2 style="text-align:center;">Exam Diagrams</h2>
        <p style="text-align:center; color:red; font-weight:bold;">DO NOT SWITCH TABS. MONITORING IS ACTIVE.</p>
        
        <img src="1.png" alt="Diagram 1" class="exam-image" onerror="this.src='https://via.placeholder.com/800x400?text=Image+1+Missing'">
        <img src="2.png" alt="Diagram 2" class="exam-image" onerror="this.src='https://via.placeholder.com/800x400?text=Image+2+Missing'">
        <img src="3.png" alt="Diagram 3" class="exam-image" onerror="this.src='https://via.placeholder.com/800x400?text=Image+3+Missing'">

        <br><br>
        <button class="btn" id="submitBtn" onclick="finishSession()">I Have Finished Studying</button>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097",
      measurementId: "G-84YB5CYGM8"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch (e) {
        console.error("Firebase Error:", e);
        document.getElementById('login-error').innerText = "Database Error.";
        document.getElementById('login-error').style.display = 'block';
    }

    // --- CHEAT TRACKING LOGIC ---
    let switchCount = 0;
    let cheatLogs = [];

    // This listens for Tab Switching or Minimizing
    document.addEventListener("visibilitychange", () => {
        const studentName = document.getElementById('studentName').value || "Unknown";
        
        if (document.hidden) {
            // User LEFT the tab
            switchCount++;
            const time = new Date().toLocaleTimeString();
            cheatLogs.push(`Left at ${time}`);
            
            // Show Alert
            const alertBox = document.getElementById('cheat-alert');
            alertBox.style.display = 'block';
            alertBox.innerText = `⚠️ WARNING: You switched tabs! Count: ${switchCount}`;
            
            console.log(`Cheat Detected: ${studentName} switched tabs. Count: ${switchCount}`);
        }
    });

    // --- START LOGIC ---
    async function startExam() {
        const cls = document.getElementById('studentClass').value;
        const no = document.getElementById('studentNo').value;
        const name = document.getElementById('studentName').value;
        const btn = document.getElementById('startBtn');

        if (!cls || !no || !name) {
            alert("Please enter Class, Number, and Name.");
            return;
        }

        btn.disabled = true;
        btn.innerText = "Loading...";

        // Log the "Start" event to Firebase
        try {
            await db.collection("exam_results").add({
                type: "START_LOG",
                name: name,
                class: cls,
                number: no,
                timestamp: new Date().toString(),
                status: "Started Viewing"
            });

            // Switch Screens
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('exam-section').style.display = 'block';

            // Go Fullscreen (Optional - makes it harder to cheat)
            document.documentElement.requestFullscreen().catch(e => console.log(e));

        } catch (e) {
            alert("Connection Error. Refresh and try again.");
            btn.disabled = false;
        }
    }

    // --- FINISH LOGIC ---
    async function finishSession() {
        const name = document.getElementById('studentName').value;
        const cls = document.getElementById('studentClass').value;
        const no = document.getElementById('studentNo').value;
        const btn = document.getElementById('submitBtn');

        if(!confirm("Are you sure you are done? Your cheat log will be submitted.")) return;

        btn.disabled = true;
        btn.innerText = "Saving...";

        try {
            // Save the FINAL report to Firebase
            await db.collection("exam_results").add({
                type: "FINAL_REPORT",
                name: name,
                class: cls,
                number: no,
                cheat_count: switchCount, // <--- The important part
                cheat_details: cheatLogs.join(" | "),
                timestamp: new Date().toString()
            });

            document.body.innerHTML = `
                <div class="container" style="text-align:center">
                    <h1 style="color:green">Session Closed</h1>
                    <p>You switched tabs <strong>${switchCount}</strong> times.</p>
                    <p>Data sent to teacher.</p>
                </div>`;
                
        } catch (e) {
            alert("Error saving data. Check internet.");
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
