<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final English Assessment</title>
    <style>
        :root {
            --primary: #4f46e5;
            --danger: #ef4444;
            --success: #10b981;
            --bg: #f3f4f6;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: #1f2937; line-height: 1.5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #111827; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }
        .question-block { background: #f9fafb; border: 1px solid #e5e7eb; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 8px; border-left: 5px solid var(--primary); }
        .q-text { font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem; }
        .mcq-option { display: flex; align-items: center; padding: 8px 0; cursor: pointer; }
        .mcq-option input { width: auto; margin-right: 10px; cursor: pointer; }
        .btn { display: block; width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .btn:hover { background: #4338ca; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        #cheat-alert { background: #fee2e2; border: 1px solid #f87171; color: #991b1b; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; display: none; text-align: center; font-weight: bold; animation: pulse 2s infinite; }
        #timer-box { position: fixed; top: 15px; right: 15px; background: #111827; color: #fff; padding: 10px 20px; border-radius: 8px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: none; z-index: 9999; border: 2px solid var(--primary); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        #exam-section { display: none; }
        #status-msg { text-align: center; margin-top: 1rem; font-weight: 600; }
        .error-msg { color: var(--danger); font-weight: bold; text-align: center; margin-top: 10px; display:none; padding: 10px; background: #fee2e2; border-radius: 4px; }
        .teacher-link { text-align: center; margin-top: 15px; font-size: 0.85rem; color: #9ca3af; cursor: pointer; text-decoration: underline; }
        .teacher-link:hover { color: #4b5563; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div id="timer-box">⏱️ 01:30:00</div>

<div class="container">
    <div id="cheat-alert">⚠️ WARNING: You have left the exam screen! This event is being recorded.</div>

    <div id="login-section">
        <h1>Student Login</h1>
        <div class="form-group">
            <label>Class</label>
            <select id="studentClass">
                <option value="">Select your class...</option>
                <option value="XII H">XII H</option>
                <option value="XII I">XII I</option>
            </select>
        </div>
        <div class="form-group">
            <label>Student Number (No. Absen)</label>
            <input type="number" id="studentNo" placeholder="e.g. 15">
        </div>
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="studentName" placeholder="Enter your full name">
        </div>
        <button class="btn" id="startBtn" onclick="startExam()">Start Exam</button>
        <p class="error-msg" id="login-error"></p>
        <div class="teacher-link" onclick="teacherLogin()">Teacher's Login</div>
    </div>

    <div id="exam-section">
        <h1>Final English Exam</h1>
        <div style="text-align:center; margin-bottom:20px; color:#666;">Answer carefully. Do not switch tabs.</div>
        <div id="questions-container"></div>
        <button class="btn" id="submitBtn" onclick="submitExam()">Submit Answers</button>
        <p id="status-msg"></p>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097",
      measurementId: "G-84YB5CYGM8"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase initialized");
    } catch (e) {
        console.error("Firebase Error:", e);
        alert("System Error: Could not connect to database.");
    }

    const EXAM_DATA = [
        { id: 1, type: "mcq", question: "By the time the final results were published, the lead scientist ____ the entire experimental procedure three times to ensure accuracy.", options: ["verifies", "had verified", "was verifying", "has verified", "is verifying"], answer: "had verified" },
        { id: 2, type: "mcq", question: "While the team ____ the complex data, the supervisor walked around the office providing constructive criticism.", options: ["analyzed", "was analyzing", "had analyzed", "analyzes", "has analyzed"], answer: "was analyzing" },
        { id: 3, type: "mcq", question: "Whenever the market ____ an unexpected shift, the investment firm immediately adjusts its portfolio risk assessment.", options: ["detected", "has detected", "detects", "is detecting", "had detected"], answer: "detects" },
        { id: 4, type: "mcq", question: "They ____ the prototype design by Friday next week, so the engineering director asked them to prepare the final schematics this week.", options: ["have finalized", "finalize", "will finalize", "will have finalized", "are finalizing"], answer: "will have finalized" },
        { id: 5, type: "mcq", question: "I ____ to accept the new position, but I received a better offer from my current employer at the last minute.", options: ["intend", "was intending", "had intended", "have intended", "am intending"], answer: "had intended" },
        { id: 6, type: "mcq", question: "Had the committee foreseen the technical glitches, they ____ the product launch until the hardware was fully tested.", options: ["would delay", "will delay", "had delayed", "would have delayed", "delayed"], answer: "would have delayed" },
        { id: 7, type: "mcq", question: "If you cool liquid nitrogen below its boiling point, it ____ and becomes a liquid again.", options: ["condenses", "will condensate", "condensed", "is condensing", "condensates"], answer: "condenses" },
        { id: 8, type: "mcq", question: "If the supply chain had not been disrupted last month, the company ____ its current production quotas now.", options: ["meets", "would meet", "will meet", "would be meeting", "had met"], answer: "would be meeting" },
        { id: 9, type: "mcq", question: "If the CEO ____ the policy, the employees will stage a protest.", options: ["ignores", "ignored", "had ignored", "would ignore", "would have ignored"], answer: "ignores" },
        { id: 10, type: "mcq", question: "Unless the temperature ____ above 37°C, the chemical reaction will not begin.", options: ["raises", "raised", "will raise", "is raising", "rises"], answer: "rises" },
        { id: 11, type: "mcq", question: "According to the university’s honor code, all students ____ cite their sources correctly when submitting academic work.", options: ["should", "ought", "must", "need", "have"], answer: "must" },
        { id: 12, type: "mcq", question: "If you are serious about becoming fluent, you ____ practice speaking the language every day for at least 30 minutes.", options: ["must", "have", "should", "need", "ought"], answer: "should" },
        { id: 13, type: "mcq", question: "All laboratory personnel ____ wear protective eyewear while handling corrosive substances, as mandated by federal safety standards.", options: ["ought", "should", "must", "have", "need"], answer: "must" },
        { id: 14, type: "mcq", question: "The new recruits ____ pass a comprehensive background check before being granted access to classified documents.", options: ["ought to", "should", "have to", "must", "need"], answer: "must" },
        { id: 15, type: "mcq", question: "To minimize risk in trading, investors ____ diversify their holdings across different markets and asset classes.", options: ["ought to", "must", "have", "should", "need"], answer: "should" },
        { id: 16, type: "mcq", question: "The government postponed ____ the new environmental taxes until the next fiscal quarter due to public resistance.", options: ["to introduce", "introducing", "to have introduced", "introduce", "having introduced"], answer: "introducing" },
        { id: 17, type: "mcq", question: "Scientists hope ____ a cure for the rare genetic disorder within the next decade using emerging technology.", options: ["discovering", "to discover", "discover", "having discovered", "to be discovered"], answer: "to discover" },
        { id: 18, type: "mcq", question: "The security guard admitted ____ the door unlocked when he left the building, which led to the theft of equipment.", options: ["to leave", "leaving", "to have left", "leave", "left"], answer: "leaving" },
        { id: 19, type: "mcq", question: "We decided ____ the old servers instead of repairing them, as the cost of maintenance was proving prohibitive.", options: ["replacing", "to replace", "replace", "to be replaced", "having replaced"], answer: "to replace" },
        { id: 20, type: "mcq", question: "The company avoids ____ raw materials from sources that lack certified ethical production standards.", options: ["to purchase", "purchasing", "purchase", "to be purchasing", "having purchased"], answer: "purchasing" },
        { id: 21, type: "mcq", question: "The sensitive laboratory samples ____ in a cryogenic freezer until the lead researcher is ready to begin the analysis.", options: ["are storing", "store", "are stored", "were stored", "have stored"], answer: "are stored" },
        { id: 22, type: "mcq", question: "The new compliance guidelines ____ by the legal department before they are officially implemented across the firm.", options: ["are reviewing", "reviewed", "were reviewed", "will be reviewed", "have reviewing"], answer: "will be reviewed" },
        { id: 23, type: "mcq", question: "The faulty pressure sensor ____ before the equipment could be safely restarted for the next phase of testing.", options: ["had repaired", "was repairing", "had been repaired", "repaired", "has repaired"], answer: "had been repaired" },
        { id: 24, type: "mcq", question: "The controversial memo ____ by the media as soon as it was leaked, causing immediate public outcry.", options: ["was publishing", "published", "were published", "was published", "have published"], answer: "was published" },
        { id: 25, type: "mcq", question: "The architectural plans ____ and approved by the city planning commission last week.", options: ["are reviewing", "reviewed", "were reviewed", "have reviewing", "had reviewing"], answer: "were reviewed" },
        { id: 26, type: "mcq", question: "Educators must consider ethical implications when using predictive analytics, and they have to ____ lesson plans based on algorithmic recommendations.", options: ["adapting", "adapt", "to adapt", "adapts", "adaption"], answer: "adapt" },
        { id: 27, type: "mcq", question: "Authors submitting to peer-reviewed journals have to ____ that their data is reproducible, and they must include raw datasets.", options: ["ensuring", "ensure", "ensures", "to ensuring", "ensured"], answer: "ensure" },
        { id: 28, type: "mcq", question: "During her first year, the resident struggled to get used to the overnight ____, especially since she was used to working standard hours.", options: ["shift’s", "shifts", "shifting", "shift is", "shifted"], answer: "shifts" },
        { id: 29, type: "mcq", question: "The firm’s senior partner had trouble ____ to collaborative design platforms, as he used to draft everything manually on tracing paper.", options: ["being used", "get used", "to get used", "getting used", "to be used"], answer: "getting used" },
        { id: 30, type: "mcq", question: "The lecturer emphasized the need to ____ fiscal policy through a long-term lens, especially when considering intergenerational equity.", options: ["evaluating", "evaluate", "evaluates", "evaluated", "to evaluating"], answer: "evaluate" },
        { id: 31, type: "text", question: "Translate: 'Saya sedang mencoba memahami instruksi yang diberikan oleh guru.'", accepted_answers: ["I am trying to understand the instructions given by the teacher", "I'm trying to understand the instructions given by the teacher", "I am trying to understand the instructions the teacher gave"] },
        { id: 32, type: "text", question: "Translate: 'Mereka memutuskan untuk menunda perjalanan karena cuacanya buruk.'", accepted_answers: ["They decided to postpone the trip because the weather was bad", "They decided to delay the trip because of bad weather", "They decided to postpone the trip because of the bad weather"] },
        { id: 33, type: "text", question: "Translate: 'Bisakah kamu menjelaskan alasan mengapa kamu datang terlambat hari ini?'", accepted_answers: ["Can you explain the reason why you came late today?", "Can you explain why you are late today?", "Could you explain the reason why you arrived late today?"] },
        { id: 34, type: "text", question: "Translate: 'Kami sudah bekerja pada proyek ini selama lebih dari dua minggu.'", accepted_answers: ["We have been working on this project for more than two weeks", "We've been working on this project for over two weeks", "We have worked on this project for more than two weeks"] },
        { id: 35, type: "text", question: "Translate: 'Walaupun dia lelah, dia tetap menyelesaikan pekerjaannya.'", accepted_answers: ["Even though he was tired, he still finished his work", "Although he was tired, he finished his work", "Even though he was tired he still completed his work"] },
        { id: 36, type: "text", question: "Translate: 'Saya tertarik untuk belajar lebih banyak tentang budaya negara lain.'", accepted_answers: ["I am interested in learning more about the culture of other countries", "I'm interested in learning more about other countries' cultures", "I am interested to learn more about the culture of other countries"] },
        { id: 37, type: "text", question: "Translate: 'Apakah kamu tahu siapa yang bertanggung jawab atas acara tersebut?'", accepted_answers: ["Do you know who is responsible for the event?", "Do you know who is responsible for that event?", "Do you know who is in charge of the event?"] },
        { id: 38, type: "text", question: "Translate: 'Jika saya punya cukup waktu, saya akan membantu kamu menyelesaikan tugas itu.'", accepted_answers: ["If I had enough time, I would help you finish the task", "If I had enough time I would help you finish that task", "If I had enough time, I would help you complete the task"] },
        { id: 39, type: "text", question: "Translate: 'Dia tidak menyangka bahwa hasil ujian akan sebaik itu.'", accepted_answers: ["He did not expect that the exam results would be that good", "He didn't expect the exam results to be that good", "She did not expect that the exam results would be that good"] },
        { id: 40, type: "text", question: "Translate: 'Kami berharap dapat bertemu dengan Anda lagi di masa depan.'", accepted_answers: ["We hope to see you again in the future", "We hope to meet you again in the future", "We look forward to seeing you again in the future"] }
    ];

    function normalizeText(text) {
        if (!text) return "";
        return text.toLowerCase().replace(/[.,!?;:'"()]/g, "").replace(/\s+/g, " ").trim();
    }

    const container = document.getElementById('questions-container');
    function renderQuestions() {
        container.innerHTML = "";
        EXAM_DATA.forEach((q, index) => {
            const num = index + 1;
            let html = `<div class="question-block"><div class="q-text">${num}. ${q.question}</div>`;
            if (q.type === "mcq") {
                q.options.forEach(opt => {
                    html += `<label class="mcq-option"><input type="radio" name="q${q.id}" value="${opt}"> ${opt}</label>`;
                });
            } else {
                html += `<input type="text" id="q${q.id}" placeholder="Type your answer here..." autocomplete="off">`;
            }
            html += `</div>`;
            container.innerHTML += html;
        });
    }

    let timerInterval;
    function startTimer(duration) {
        let timer = duration, hours, minutes, seconds;
        const display = document.getElementById('timer-box');
        display.style.display = 'block';
        timerInterval = setInterval(function () {
            hours = parseInt(timer / 3600, 10);
            minutes = parseInt((timer % 3600) / 60, 10);
            seconds = parseInt(timer % 60, 10);
            hours = hours < 10 ? "0" + hours : hours;
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            display.textContent = `⏱️ ${hours}:${minutes}:${seconds}`;
            if (--timer < 0) {
                clearInterval(timerInterval);
                alert("⏰ TIME IS UP! Submitting your answers automatically.");
                submitExam(true); 
            }
        }, 1000);
    }

    let switchCount = 0;
    let evidenceLogs = []; 
    document.addEventListener("visibilitychange", () => {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        if (document.hidden) {
            switchCount++;
            evidenceLogs.push(`[LEFT at ${timeString}]`);
            const alertBox = document.getElementById('cheat-alert');
            alertBox.style.display = 'block';
            alertBox.innerText = `⚠️ ALERT: You left the screen! Count: ${switchCount}`;
        } else {
            evidenceLogs.push(`[RETURNED at ${timeString}]`);
        }
    });

    function teacherLogin() {
        const pass = prompt("Enter Teacher Password:");
        if (pass === "030") {
            document.getElementById('studentClass').value = "XII H";
            document.getElementById('studentNo').value = "0";
            document.getElementById('studentName').value = "TEACHER_TEST";
            startExam(true);
        } else {
            alert("Incorrect Password");
        }
    }

    async function startExam(isTeacher = false) {
        const btn = document.getElementById('startBtn');
        const errorMsg = document.getElementById('login-error');
        const cls = document.getElementById('studentClass').value;
        const no = document.getElementById('studentNo').value;
        const name = document.getElementById('studentName').value;
        
        if(!cls || !no || !name) { alert("Please fill in all details."); return; }

        const EXAM_START_DATE = new Date("2025-12-04T20:00:00+07:00");
        const now = new Date();

        if (!isTeacher && now < EXAM_START_DATE) {
            alert("⏳ The exam has not started yet.\nPlease come back at 8:00 PM (20:00 WIB).");
            return;
        }

        btn.disabled = true;
        btn.innerText = "Checking access...";
        errorMsg.style.display = 'none';

        const uniqueID = `${cls}_${no}`;

        try {
            if (!isTeacher) {
                const docRef = db.collection("exam_starts").doc(uniqueID);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    btn.innerText = "Access Denied";
                    errorMsg.innerText = `⛔ ERROR: You already started this exam at ${data.startTime}. Resetting is not allowed.`;
                    errorMsg.style.display = 'block';
                    return; 
                }
                await docRef.set({ class: cls, number: no, name: name, startTime: new Date().toLocaleTimeString(), timestamp: new Date().toString() });
            }

            document.getElementById('login-section').style.display = 'none';
            document.getElementById('exam-section').style.display = 'block';
            renderQuestions();
            startTimer(5400); 

        } catch (e) {
            console.error(e);
            if (e.code === 'permission-denied') {
                alert("⛔ ERROR: Database is LOCKED. Teacher needs to change Firebase Rules to 'allow read, write: if true;'");
            } else {
                alert("Connection error: " + e.message);
            }
            btn.disabled = false;
            btn.innerText = "Start Exam";
        }
    }

    async function submitExam(isAuto = false) {
        if(!isAuto && !confirm("Are you sure you want to finish?")) return;
        clearInterval(timerInterval);

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        document.getElementById('status-msg').innerText = "Grading and submitting...";

        let score = 0;
        let totalQuestions = EXAM_DATA.length;
        let answerSheet = [];
        let gradingSheet = [];

        EXAM_DATA.forEach(q => {
            let userAns = "";
            let isCorrect = false;

            if (q.type === "mcq") {
                const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
                userAns = selected ? selected.value : "";
                if (userAns === q.answer) isCorrect = true;
            } else {
                const input = document.getElementById(`q${q.id}`);
                userAns = input.value.trim();
                const cleanUser = normalizeText(userAns);
                if (q.accepted_answers.some(ans => normalizeText(ans) === cleanUser)) {
                    isCorrect = true;
                }
            }
            
            if (isCorrect) score++;
            
            answerSheet.push(`Q${q.id}:${userAns.replace(/\|/g, "-")}`); 
            gradingSheet.push(isCorrect ? "1" : "0");
        });

        let finalPercentage = Math.round((score / totalQuestions) * 100);

        try {
            await db.collection("exam_results").add({
                class: document.getElementById('studentClass').value,
                number: document.getElementById('studentNo').value,
                name: document.getElementById('studentName').value,
                total_score: finalPercentage,
                raw_score: `${score}/${totalQuestions}`,
                cheat_count: switchCount,
                evidence_logs: evidenceLogs.join(" | "), 
                all_answers: answerSheet.join(" | "),
                answer_key_status: gradingSheet.join(" | "),
                timestamp: new Date().toString()
            });
            
            document.getElementById('status-msg').innerText = "✅ Submitted! You can close this tab.";
            
            if(!isAuto) {
                alert(`Exam Submitted!\nYour Score: ${finalPercentage}%`);
            } else {
                document.body.innerHTML = `<div class="container" style="text-align:center"><h1>⏰ Time's Up!</h1><p>Your exam was automatically submitted.</p><h2>Score: ${finalPercentage}%</h2></div>`;
            }

        } catch (e) {
            console.error(e);
            alert("Error submitting. Check your internet connection.");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
