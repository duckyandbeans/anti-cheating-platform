<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JE 7 - Vocab Quiz 3</title>
    <style>
        :root {
            --primary: #4f46e5;
            --danger: #ef4444;
            --success: #10b981;
            --bg: #f3f4f6;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: #1f2937; line-height: 1.5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        h1 { text-align: center; color: #111827; margin-bottom: 2rem; }
        
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* Question Cards */
        .question-block { 
            background: #f9fafb; 
            border: 1px solid #e5e7eb; 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
            border-radius: 8px; 
            border-left: 5px solid var(--primary);
        }
        .q-text { font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem; }
        
        /* MCQ Options */
        .mcq-option { display: flex; align-items: center; padding: 8px 0; cursor: pointer; }
        .mcq-option input { width: auto; margin-right: 10px; cursor: pointer; }
        
        /* Buttons */
        .btn { 
            display: block; 
            width: 100%; 
            padding: 1rem; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-size: 1.1rem; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .btn:hover { background: #4338ca; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }

        /* Alerts */
        #cheat-alert { 
            background: #fee2e2; 
            border: 1px solid #f87171; 
            color: #991b1b; 
            padding: 1rem; 
            border-radius: 8px; 
            margin-bottom: 2rem; 
            display: none; 
            text-align: center; 
            font-weight: bold; 
            animation: pulse 2s infinite;
        }

        /* TIMER BOX */
        #timer-box {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #111827;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none; /* Hidden until exam starts */
            z-index: 9999;
            border: 2px solid var(--primary);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        #exam-section { display: none; }
        #status-msg { text-align: center; margin-top: 1rem; font-weight: 600; }
        .error-msg { color: var(--danger); font-weight: bold; text-align: center; margin-top: 10px; display:none; padding: 10px; background: #fee2e2; border-radius: 4px; }
        
        .teacher-link {
            text-align: center; margin-top: 25px; font-size: 0.85rem; color: #9ca3af; cursor: pointer; text-decoration: underline;
        }
        .teacher-link:hover { color: #4b5563; }
        
        .intro-text {
            text-align: center; color: #4b5563; margin-bottom: 2rem;
        }
    </style>
    
    <!-- LOAD FIREBASE (COMPAT VERSION) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- TIMER DISPLAY -->
<div id="timer-box">⏱️ 01:30:00</div>

<div class="container">
    <div id="cheat-alert">⚠️ WARNING: You have left the exam screen! This event is being recorded.</div>

    <!-- 1. SIMPLIFIED WELCOME SCREEN -->
    <div id="login-section">
        <h1>JE 7 - Vocab Quiz 3</h1>
        <p class="intro-text">
            Welcome. You have 90 minutes to complete this exam.<br>
            Please do not switch tabs or exit the browser.
        </p>
        
        <button class="btn" id="startBtn" onclick="startExam()">Start Exam</button>
        <p class="error-msg" id="login-error"></p>
        
        <!-- TEACHER LOGIN LINK -->
        <div class="teacher-link" onclick="teacherLogin()">Teacher's Login</div>
    </div>

    <!-- 2. EXAM SCREEN -->
    <div id="exam-section">
        <h1>JE 7 - Vocab Quiz 3</h1>
        <div style="text-align:center; margin-bottom:20px; color:#666;">
            Answer carefully. Do not switch tabs.
        </div>
        <div id="questions-container"></div>
        <button class="btn" id="submitBtn" onclick="submitExam()">Submit Answers</button>
        <p id="status-msg"></p>
    </div>
</div>

<script>
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097",
      measurementId: "G-84YB5CYGM8"
    };

    // Initialize Firebase
    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase initialized successfully");
    } catch (e) {
        console.error("Firebase Error:", e);
        // Show init error immediately
        document.getElementById('login-error').innerText = "System Error: Could not connect to database configuration.";
        document.getElementById('login-error').style.display = 'block';
    }

    // ============================================
    // EXAM QUESTIONS DATA (FROM IMAGE)
    // ============================================
    const EXAM_DATA = [
        { id: 1, type: "text", question: "It took us 10 minutes to n_______ (move about) through the parking lot to the exit.", accepted_answers: ["navigate"] },
        { id: 2, type: "text", question: "He was f_______ (struggling to move) around in the pool like an amateur.", accepted_answers: ["floundering", "flounder"] },
        { id: 3, type: "text", question: "It is obvious that p_______ (chaotic situation) would exist at most uncontrolled airports if every pilot did not conscientiously follow the traffic pattern.", accepted_answers: ["pandemonium"] },
        { id: 4, type: "text", question: "Every parent has watched their child t_______ (walk laboriously) off to school with a backpack over their shoulders.", accepted_answers: ["trudge", "trudging"] },
        { id: 5, type: "text", question: "One family walked on a r_______ (worn out) pathway of boards over a sprawl of sticky black mud in their yard.", accepted_answers: ["rickety", "ramshackle", "rotten"] },
        { id: 6, type: "text", question: "The robbers then c_______ (climb with effort) aboard, armed with bolt-cutters for which the freight-car locks are no match.", accepted_answers: ["clambered", "clamber"] },
        { id: 7, type: "text", question: "If someone was moving, for instance, the quilt would serve as a m_______ (souvenir) of their former home.", accepted_answers: ["memento"] },
        { id: 8, type: "text", question: "Of all the stuff your child will s_______ (scatter) about your home for two more decades, a box of tiny teeth is probably the easiest thing to stow away.", accepted_answers: ["strew"] },
        { id: 9, type: "text", question: "There is no door alarm to warn you that one of the fridge's doors is a_______ (slightly open).", accepted_answers: ["ajar"] },
        { id: 10, type: "text", question: "The volcano s_______ (burst out) hot ash.", accepted_answers: ["spewed", "spews", "spouted"] },
        { id: 11, type: "text", question: "He c_______ (laugh silently) as he read the comic strip.", accepted_answers: ["chuckled", "chuckle"] },
        { id: 12, type: "text", question: "People might b_______ (wave) you to come and join up for some group fun, but your own agenda could get in the way.", accepted_answers: ["beckon"] },
        { id: 13, type: "text", question: "His method is to push down the barb below the flesh, loop the shoestring around the hook and y_______ (pull) fast.", accepted_answers: ["yank"] },
        { id: 14, type: "text", question: "The chickens are able to r_______ (explore) around freely in the farmyard.", accepted_answers: ["roam"] },
        { id: 15, type: "text", question: "She t_______ (threw) the ball high in the air.", accepted_answers: ["tossed", "toss"] },
        { id: 16, type: "text", question: "Few of their possessions were s_______ (saved) from the fire.", accepted_answers: ["salvaged"] },
        { id: 17, type: "text", question: "Discussions about money can lead couples into t_______ (marked with hidden danger) territory.", accepted_answers: ["treacherous"] },
        { id: 18, type: "text", question: "For much of the cruise, the Galley slung a hash of b_______ (confusion) and frustration.", accepted_answers: ["bewilderment"] },
        { id: 19, type: "text", question: "Try to avoid c_______ (covered with disordered things) your desk with books and papers.", accepted_answers: ["cluttering", "clutter"] },
        { id: 20, type: "text", question: "He s_______ (acted or carried things in a secretive way) a few cookies out of the jar while his mother wasn't looking.", accepted_answers: ["smuggled", "sneaked", "snuck"] }
    ];

    // ============================================
    // APPLICATION LOGIC
    // ============================================
    
    // 1. Punctuation & Case Normalizer
    function normalizeText(text) {
        if (!text) return "";
        return text.toLowerCase().replace(/[.,!?;:'"()]/g, "").replace(/\s+/g, " ").trim();
    }

    // 2. Render Questions
    const container = document.getElementById('questions-container');
    function renderQuestions() {
        container.innerHTML = "";
        EXAM_DATA.forEach((q, index) => {
            const num = index + 1;
            let html = `<div class="question-block"><div class="q-text">${num}. ${q.question}</div>`;
            
            if (q.type === "mcq") {
                q.options.forEach(opt => {
                    html += `<label class="mcq-option">
                                <input type="radio" name="q${q.id}" value="${opt}"> ${opt}
                             </label>`;
                });
            } else {
                html += `<input type="text" id="q${q.id}" placeholder="Type your answer here..." autocomplete="off">`;
            }
            html += `</div>`;
            container.innerHTML += html;
        });
    }

    // 3. TIMER LOGIC (1h 30m = 90 mins = 5400 seconds)
    let timerInterval;
    function startTimer(duration) {
        let timer = duration, hours, minutes, seconds;
        const display = document.getElementById('timer-box');
        display.style.display = 'block';

        timerInterval = setInterval(function () {
            hours = parseInt(timer / 3600, 10);
            minutes = parseInt((timer % 3600) / 60, 10);
            seconds = parseInt(timer % 60, 10);

            hours = hours < 10 ? "0" + hours : hours;
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = `⏱️ ${hours}:${minutes}:${seconds}`;

            if (--timer < 0) {
                clearInterval(timerInterval);
                alert("⏰ TIME IS UP! Submitting your answers automatically.");
                submitExam(true); 
            }
        }, 1000);
    }

    // 4. Anti-Cheat & Logger
    let switchCount = 0;
    let evidenceLogs = []; 

    document.addEventListener("visibilitychange", () => {
        const now = new Date();
        const timeString = now.toLocaleTimeString();

        if (document.hidden) {
            switchCount++;
            evidenceLogs.push(`[LEFT at ${timeString}]`);
            const alertBox = document.getElementById('cheat-alert');
            alertBox.style.display = 'block';
            alertBox.innerText = `⚠️ ALERT: You left the screen! Count: ${switchCount}`;
        } else {
            evidenceLogs.push(`[RETURNED at ${timeString}]`);
        }
    });

    // 5. TEACHER LOGIN LOGIC
    function teacherLogin() {
        const pass = prompt("Enter Teacher Password:");
        if (pass === "030") {
            // Start in Teacher Mode
            startExam(true);
        } else {
            alert("Incorrect Password");
        }
    }

    // 6. START EXAM (SIMPLIFIED FOR SINGLE STUDENT)
    async function startExam(isTeacher = false) {
        const btn = document.getElementById('startBtn');
        const errorMsg = document.getElementById('login-error');
        
        // --- TIME LOCK (8 PM WIB on Dec 4, 2025) ---
        // Note: Date is in past now for testing, but logic remains valid.
        const EXAM_START_DATE = new Date("2025-12-04T20:00:00+07:00");
        const now = new Date();

        if (!isTeacher && now < EXAM_START_DATE) {
            alert("⏳ The exam has not started yet.\nPlease come back at 8:00 PM (20:00 WIB).");
            return;
        }

        btn.disabled = true;
        btn.innerText = "Checking access...";
        errorMsg.style.display = 'none';

        // Hardcoded IDs for single student mode
        let uniqueID, name, cls, no;

        if (isTeacher) {
            uniqueID = "TEACHER_TEST";
            name = "TEACHER_TEST";
            cls = "TEACHER";
            no = "0";
        } else {
            uniqueID = "SINGLE_USER";
            name = "Student";
            cls = "Single";
            no = "1";
        }

        try {
            // Check Database for existing user (Anti-Reset)
            // Even though it's one student, we keep this to prevent refresh/restart exploits
            if (!isTeacher) {
                const docRef = db.collection("exam_starts").doc(uniqueID);
                const docSnap = await docRef.get();

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    btn.innerText = "Access Denied";
                    errorMsg.innerHTML = `⛔ ERROR: Exam already started at ${data.startTime}.<br>Refresh/Restart is not allowed.<br>Contact teacher to reset.`;
                    errorMsg.style.display = 'block';
                    return; 
                }

                // Log start time to prevent reset
                await docRef.set({
                    class: cls,
                    number: no,
                    name: name,
                    startTime: new Date().toLocaleTimeString(),
                    timestamp: new Date().toString()
                });
            }

            document.getElementById('login-section').style.display = 'none';
            document.getElementById('exam-section').style.display = 'block';
            renderQuestions();
            
            // START 90 MINUTE TIMER (5400 seconds)
            startTimer(5400); 

        } catch (e) {
            console.error(e);
            // REVEAL THE ACTUAL ERROR FOR DEBUGGING
            const actualError = e.message || e;
            alert("System Error: " + actualError + "\n\n(Check your internet connection or Firebase Rules)");
            btn.disabled = false;
            btn.innerText = "Start Exam";
        }
    }

    async function submitExam(isAuto = false) {
        if(!isAuto && !confirm("Are you sure you want to finish?")) return;
        
        clearInterval(timerInterval);

        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('status-msg');
        btn.disabled = true;
        status.innerText = "Grading and submitting...";
        status.style.color = "blue";

        // Grading Logic
        let score = 0;
        let totalQuestions = EXAM_DATA.length;
        let answerSheet = [];
        let gradingSheet = [];

        // Set name based on mode (Teacher/Student)
        // We can't access inputs anymore, so we default to "Student" unless it was a teacher run
        // But for submission, we'll just log it as "Student" if not tracked otherwise. 
        // *Correction*: We can just log "Student" for everyone except when verified as teacher.
        // For simplicity in this function, we'll assume "Student" unless we added global vars.
        // Let's just use "Student" for the submission record since there's only one.
        const studentName = (typeof window.isTeacherRun !== 'undefined' && window.isTeacherRun) ? "TEACHER_TEST" : "Student";

        EXAM_DATA.forEach(q => {
            let userAns = "";
            let isCorrect = false;

            if (q.type === "mcq") {
                const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
                userAns = selected ? selected.value : "";
                if (userAns === q.answer) isCorrect = true;
            } else {
                const input = document.getElementById(`q${q.id}`);
                userAns = input.value.trim();
                const cleanUser = normalizeText(userAns);
                if (q.accepted_answers.some(ans => normalizeText(ans) === cleanUser)) {
                    isCorrect = true;
                }
            }
            
            if (isCorrect) score++;
            
            // --- DETAILED LOGGING (Answers & 1/0) ---
            answerSheet.push(`Q${q.id}:${userAns.replace(/\|/g, "-")}`); // Prevent pipe conflict
            gradingSheet.push(isCorrect ? "1" : "0");
        });

        let finalPercentage = Math.round((score / totalQuestions) * 100);

        try {
            await db.collection("exam_results").add({
                class: "Single",
                number: "1",
                name: studentName,
                total_score: finalPercentage,
                raw_score: `${score}/${totalQuestions}`,
                cheat_count: switchCount,
                evidence_logs: evidenceLogs.join(" | "), 
                all_answers: answerSheet.join(" | "),
                answer_key_status: gradingSheet.join(" | "),
                timestamp: new Date().toString()
            });
            
            status.style.color = "green";
            status.innerText = "✅ Submitted! You can close this tab.";
            
            if(!isAuto) {
                alert(`Exam Submitted!\nYour Score: ${finalPercentage}%`);
            } else {
                document.body.innerHTML = `<div class="container" style="text-align:center"><h1>⏰ Time's Up!</h1><p>Your exam was automatically submitted.</p><h2>Score: ${finalPercentage}%</h2></div>`;
            }

        } catch (e) {
            console.error(e);
            alert("Error submitting. Check your internet connection.");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
