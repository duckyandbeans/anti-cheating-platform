<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade XII: Grammar Mastery</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --error: #c0392b; --bg: #ecf0f1; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: var(--bg); color: #2c3e50; user-select: none; }
        
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        h1, h2 { color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 10px; }
        
        /* MATERIAL STYLES */
        .material-card { background: #f8f9fa; border-left: 5px solid var(--accent); padding: 15px 20px; margin-bottom: 20px; }
        .example-box { background: #e8f4fd; padding: 10px; border-radius: 6px; margin-top: 10px; }
        .label { font-weight: bold; color: var(--accent); display: inline-block; width: 80px; }

        /* QUIZ STYLES */
        .quiz-item { background: white; margin-bottom: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .question-header { font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; }
        .analysis-text { font-style: italic; color: #7f8c8d; margin-bottom: 15px; font-size: 0.95rem; }
        
        input[type="text"] { width: 100%; padding: 12px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        input[type="text"]:focus { border-color: var(--accent); outline: none; }

        /* FEEDBACK */
        .feedback-container { display: none; margin-top: 15px; padding: 15px; border-radius: 6px; }
        .status-correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-wrong { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .hint-text { display: block; margin-top: 5px; font-weight: bold; color: #856404; }

        /* BUTTONS */
        .btn-container { margin-top: 30px; display: flex; gap: 10px; }
        .btn { flex: 1; padding: 15px; background-color: var(--accent); color: white; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .btn:hover { background-color: #2980b9; }
        .btn-reset { background-color: #f39c12; display: none; }
        .btn-reset:hover { background-color: #d35400; }

        /* MODAL */
        #custom-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .modal-text { color: #7f8c8d; margin-bottom: 25px; font-size: 1.1rem; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; min-width: 80px; }
        .btn-yes { background: #27ae60; color: white; }
        .btn-no { background: #95a5a6; color: white; }

        /* ANTI-CHEAT */
        #cheat-alert { background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 8px; display: none; text-align: center; font-weight: bold; position: sticky; top: 10px; z-index: 500; border: 1px solid #c0392b; }
        .cheat-counter { position: fixed; top: 15px; right: 15px; background: #fff; color: #c0392b; padding: 8px 15px; border-radius: 30px; font-size: 0.9rem; font-weight: bold; border: 2px solid #c0392b; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .watermark-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; opacity: 0.04; display: flex; flex-wrap: wrap; overflow: hidden; }
        .watermark-text { transform: rotate(-30deg); margin: 60px; font-weight: 900; font-size: 20px; color: #000; }
        
        /* LIGHTBOX */
        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100000; justify-content: center; align-items: center; }
        #lightbox img { max-width: 90%; max-height: 90%; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer; font-weight: bold; }

        /* WAITING & LOGIN */
        #waiting-room { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:99999; flex-direction:column; justify-content:center; align-items:center; text-align:center; }
        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#ecf0f1; z-index:20000; display:flex; justify-content:center; align-items:center; }
        .login-box { background:white; padding:30px; border-radius:10px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:90%; max-width:400px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body oncontextmenu="return false;">

<div id="global-watermark" class="watermark-overlay"></div>
<div id="cheat-display" class="cheat-counter">OFFENSES: 0</div>
<div id="cheat-alert">‚ö†Ô∏è ALERT: FOCUS LOST! INCIDENT RECORDED.</div>

<div class="container">
    <header style="text-align:center; margin-bottom:40px;">
        <h1>üéì English Grammar Mastery</h1>
        <p>Study the materials below, then scroll down to test your knowledge.</p>
    </header>

    <section id="materials">
        <h2>Part 1: Present Simple vs. Present Continuous</h2>
        
        <div class="material-card">
            <h3>1. Routine / Habit</h3>
            <div class="example-box">
                <div><span class="label">Sentence:</span> "Saya biasanya bangun jam 5 pagi."</div>
                <div><span class="label">Tip:</span> Gunakan <strong>Present Simple</strong> (V1 / s / es).</div>
                <div><span class="label">English:</span> "I usually wake up at 5 AM."</div>
            </div>
        </div>
        
        <div class="material-card"><h3>2. Fact / General Truth</h3><div class="example-box"><div><span class="label">Sentence:</span> "Matahari terbit di timur."</div><div><span class="label">Tip:</span> Gunakan <strong>Present Simple</strong>.</div><div><span class="label">English:</span> "The sun rises in the east."</div></div></div>
        <div class="material-card"><h3>3. Happening Now</h3><div class="example-box"><div><span class="label">Sentence:</span> "Diamlah, bayi itu sedang tidur."</div><div><span class="label">Tip:</span> Gunakan <strong>Present Continuous</strong>.</div><div><span class="label">English:</span> "Be quiet, the baby is sleeping."</div></div></div>
        
        <h2>Part 2: Past Simple vs. Present Perfect</h2>
        
        <div class="material-card"><h3>4. Indefinite Past</h3><div class="example-box"><div><span class="label">Sentence:</span> "Saya sudah menonton film itu tiga kali."</div><div><span class="label">Tip:</span> Gunakan <strong>Present Perfect</strong>.</div><div><span class="label">English:</span> "I have watched that movie three times."</div></div></div>
        <div class="material-card"><h3>5. Specific Past Time</h3><div class="example-box"><div><span class="label">Sentence:</span> "Saya menonton film itu tadi malam."</div><div><span class="label">Tip:</span> Gunakan <strong>Past Simple</strong>.</div><div><span class="label">English:</span> "I watched that movie last night."</div></div></div>
        <div class="material-card"><h3>6. Unfinished Time</h3><div class="example-box"><div><span class="label">Sentence:</span> "Saya sudah kehilangan kunci saya."</div><div><span class="label">Tip:</span> Gunakan <strong>Present Perfect</strong>.</div><div><span class="label">English:</span> "I have lost my keys."</div></div></div>

        <h2>Part 3: Past Simple vs. Past Continuous</h2>
        
        <div class="material-card"><h3>7. Completed Sequence</h3><div class="example-box"><div><span class="label">Sentence:</span> "Dia membuka pintu, lalu menyalakan lampu."</div><div><span class="label">Tip:</span> Gunakan <strong>Past Simple</strong>.</div><div><span class="label">English:</span> "He opened the door and turned on the light."</div></div></div>
        <div class="material-card"><h3>8. Interrupted Action</h3><div class="example-box"><div><span class="label">Sentence:</span> "Saya sedang makan ketika telepon berbunyi."</div><div><span class="label">Tip:</span> <strong>Past Continuous</strong> + <strong>Past Simple</strong>.</div><div><span class="label">English:</span> "I was eating when the phone rang."</div></div></div>

        <h2>Part 4: Stative Verbs</h2>
        <div class="material-card"><h3>10. Possession / State</h3><div class="example-box"><div><span class="label">Sentence:</span> "Saya punya mobil baru."</div><div><span class="label">Tip:</span> Gunakan <strong>Present Simple</strong>.</div><div><span class="label">English:</span> "I have a new car."</div></div></div>

        <div class="material-group" style="margin-top:40px;">
            <h2>Part 5: Vocabulary Enrichment</h2>
            <div class="material-card" style="border-left-color:#e67e22;">
                <h3 style="color:#e67e22;">Reference Material</h3>
                <p>Refer to this image for the projector questions.</p>
                <div style="text-align:center; background:#fff; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    <img src="vocabxii.png" alt="Vocabulary Material" style="width:100%; max-width:600px; border-radius:4px; cursor:pointer;" onclick="openLightbox(this.src)">
                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">(Tap image to zoom)</div>
                </div>
            </div>
        </div>
    </section>

    <hr style="margin:50px 0; border:0; border-top:2px solid #ddd;">

    <section id="exercises">
        <h2>üìù Translation Exercises</h2>
        <p>Translate the sentences below. <strong>(Auto-Saving Enabled)</strong></p>
        <div id="quiz-container"></div>
        
        <div class="btn-container">
            <button id="submitBtn" class="btn" onclick="triggerSubmit()">Submit Answers</button>
            <button id="resetBtn" class="btn btn-reset" onclick="triggerReset()">üîÑ Try Again</button>
        </div>
    </section>
</div>

<div id="lightbox" onclick="closeLightbox()">
    <span id="lightbox-close">&times;</span>
    <img id="lightbox-img" src="" onclick="event.stopPropagation()">
</div>

<div id="custom-modal-overlay">
    <div class="modal-box">
        <div class="modal-title" id="modal-title">Title</div>
        <div class="modal-text" id="modal-msg">Message</div>
        <div class="modal-actions" id="modal-actions"></div>
    </div>
</div>

<div id="waiting-room">
    <div style="font-size:4rem;">üîí</div>
    <h1 style="color:#2c3e50; margin-bottom:10px;">Waiting for Teacher</h1>
    <p style="color:#7f8c8d; font-size:1.1rem;">Do not refresh. The lesson will start automatically.</p>
    <div style="margin-top:20px; width:50px; height:50px; border:5px solid #bdc3c7; border-top:5px solid #3498db; border-radius:50%; animation:spin 1s linear infinite;"></div>
</div>

<div id="login-overlay" style="display:none;">
    <div class="login-box">
        <h2>Student Login</h2>
        <input type="text" id="directName" placeholder="Full Name" style="margin-bottom:10px;" autocomplete="off">
        <input type="text" id="directClass" placeholder="Class" style="margin-bottom:10px;" autocomplete="off">
        <input type="number" id="directNo" placeholder="Number" style="margin-bottom:10px;" autocomplete="off">
        <button class="btn" onclick="directLogin()">Start</button>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097"
    };
    try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){}

    const COLLECTION_NAME = "grade_xii_learning_results";
    
    // RESTORE CHEAT COUNT ON RELOAD
    let switchCount = parseInt(sessionStorage.getItem('cheat_count')) || 0;
    let sessionActive = false;
    let studentData = {};
    let ignoreBlur = false; 

    // MODAL
    function showModal(title, msg, type, callback) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-msg').innerText = msg;
        const actions = document.getElementById('modal-actions');
        actions.innerHTML = ""; 
        if(type === 'confirm') {
            const yesBtn = document.createElement('button'); yesBtn.className = 'modal-btn btn-yes'; yesBtn.innerText = "Yes";
            yesBtn.onclick = function() { closeModal(); if(callback) callback(); };
            const noBtn = document.createElement('button'); noBtn.className = 'modal-btn btn-no'; noBtn.innerText = "No";
            noBtn.onclick = closeModal;
            actions.appendChild(yesBtn); actions.appendChild(noBtn);
        } else {
            const okBtn = document.createElement('button'); okBtn.className = 'modal-btn btn-yes'; okBtn.innerText = "OK";
            okBtn.onclick = closeModal; actions.appendChild(okBtn);
        }
        document.getElementById('custom-modal-overlay').style.display = 'flex';
    }
    function closeModal() { document.getElementById('custom-modal-overlay').style.display = 'none'; }

    // QUESTIONS
    const questions = [
        {id: 1, ind: "Air mendidih pada suhu 100 derajat Celsius.", anal: "Fakta ilmiah.", tip: "Present Simple.", ans: "water boils at 100 degrees celsius"},
        {id: 2, ind: "Dengarkan! Seseorang sedang mengetuk pintu.", anal: "Sedang terjadi.", tip: "Present Continuous.", ans: "listen someone is knocking on the door"},
        {id: 3, ind: "Bumi mengelilingi matahari.", anal: "Kebenaran umum.", tip: "Present Simple.", ans: "the earth goes around the sun"},
        {id: 4, ind: "Saya tidak minum kopi, saya lebih suka teh.", anal: "Preferensi.", tip: "Present Simple (Negative).", ans: "i do not drink coffee i prefer tea"},
        {id: 5, ind: "Kenapa kamu memakai mantel? Di luar tidak dingin.", anal: "Aksi sementara.", tip: "Present Continuous.", ans: "why are you wearing a coat it is not cold outside"},
        {id: 6, ind: "Kereta berangkat setiap pagi jam 7.00.", anal: "Jadwal tetap.", tip: "Present Simple.", ans: "the train leaves at 700 every morning"},
        {id: 7, ind: "Dia sedang tidak bekerja minggu ini, dia sedang liburan.", anal: "Situasi sementara.", tip: "Present Continuous.", ans: "he is not working this week he is on holiday"},
        {id: 8, ind: "Saya kehilangan dompet saya (dan saya belum menemukannya).", anal: "Konsekuensi masa kini.", tip: "Present Perfect.", ans: "i have lost my wallet"},
        {id: 9, ind: "Saya kehilangan dompet saya kemarin.", anal: "Waktu spesifik.", tip: "Past Simple.", ans: "i lost my wallet yesterday"},
        {id: 10, ind: "Apakah kamu pernah melihat hantu?", anal: "Pengalaman hidup.", tip: "Present Perfect.", ans: "have you ever seen a ghost"},
        {id: 11, ind: "Shakespeare menulis banyak drama terkenal.", anal: "Orang sudah meninggal.", tip: "Past Simple.", ans: "shakespeare wrote many famous plays"},
        {id: 12, ind: "J.K. Rowling sudah menulis banyak buku.", anal: "Orang masih hidup.", tip: "Present Perfect.", ans: "jk rowling has written many books"},
        {id: 13, ind: "Kami tinggal di sini selama 10 tahun (sudah pindah).", anal: "Durasi selesai.", tip: "Past Simple.", ans: "we lived here for 10 years"},
        {id: 14, ind: "Kami sudah tinggal di sini selama 10 tahun (masih tinggal).", anal: "Durasi berlanjut.", tip: "Present Perfect.", ans: "we have lived here for 10 years"},
        {id: 15, ind: "Saya sedang mandi ketika lampu mati.", anal: "Aksi terpotong.", tip: "Past Continuous + Past Simple.", ans: "i was taking a shower when the lights went out"},
        {id: 16, ind: "Dia bangun, mencuci muka, dan berpakaian.", anal: "Urutan cerita.", tip: "Past Simple.", ans: "he woke up washed his face and got dressed"},
        {id: 17, ind: "Jam 8 tadi malam, saya sedang menonton TV.", anal: "Waktu spesifik lampau.", tip: "Past Continuous.", ans: "at 8 last night i was watching tv"},
        {id: 18, ind: "Sementara ibu memasak, ayah sedang membaca koran.", anal: "Dua aksi bersamaan.", tip: "Past Continuous + Past Continuous.", ans: "while mom was cooking dad was reading the newspaper"},
        {id: 19, ind: "Saya tidak mengerti pertanyaan ini sekarang.", anal: "Kata kerja mental.", tip: "Present Simple.", ans: "i do not understand this question now"},
        {id: 20, ind: "Sup ini rasanya enak.", anal: "Indra perasa.", tip: "Present Simple.", ans: "this soup tastes good"},
        {id: 21, ind: "Koki itu sedang mencicipi supnya.", anal: "Aksi fisik.", tip: "Present Continuous.", ans: "the chef is tasting the soup"},
        {id: 22, ind: "Saya punya dua saudara laki-laki.", anal: "Kepemilikan.", tip: "Present Simple.", ans: "i have two brothers"},
        {id: 23, ind: "Lihat awan itu! Hujan akan turun.", anal: "Prediksi fisik.", tip: "Going to.", ans: "look at those clouds it is going to rain"},
        {id: 24, ind: "Saya rasa manusia akan tinggal di Mars suatu hari nanti.", anal: "Opini.", tip: "Will.", ans: "i think humans will live on mars one day"},
        {id: 25, ind: "Telepon berbunyi. Saya yang akan mengangkatnya.", anal: "Keputusan spontan.", tip: "Will.", ans: "the phone is ringing i will get it"}
    ];
    const alternateAnswers = {
        3: ["the earth revolves around the sun"], 5: ["why are you wearing a coat its not cold outside"], 23: ["look at those clouds its going to rain"]
    };

    // --- LOCK & LOGIN ---
    (function() {
        const wm = document.getElementById('global-watermark');
        let html = ""; for(let i=0; i<40; i++) html += `<div class="watermark-text">LEARNING MODE<br>DO NOT CHEAT</div>`;
        wm.innerHTML = html;

        const examCode = sessionStorage.getItem('exam_code');
        if(examCode) {
            studentData = { name: sessionStorage.getItem('student_name'), class: sessionStorage.getItem('student_class'), no: sessionStorage.getItem('student_no') };
            waitForUnlock(examCode);
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
        }
    })();

    function directLogin() {
        const name = document.getElementById('directName').value; const cls = document.getElementById('directClass').value; const no = document.getElementById('directNo').value;
        if(!name || !cls || !no) { showModal("Error", "Fill all fields", "alert"); return; }
        studentData = { name, class: cls, no };
        document.getElementById('login-overlay').style.display='none';
        startSession();
    }

    function waitForUnlock(code) {
        document.getElementById('waiting-room').style.display = 'flex';
        db.collection('active_exam_codes').doc(code).onSnapshot(doc => {
            if(doc.exists && doc.data().status === "UNLOCKED") {
                document.getElementById('waiting-room').style.display = 'none';
                startSession();
            }
        });
    }

    function startSession() {
        sessionActive = true;
        document.getElementById('cheat-display').style.display = 'block';
        document.getElementById('cheat-display').innerText = `OFFENSES: ${switchCount}`;
        renderQuiz();
    }

    // --- LIGHTBOX ---
    function openLightbox(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').style.display = 'flex'; }
    function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }

    // --- QUIZ LOGIC (AUTO-SAVE ADDED) ---
    function renderQuiz() {
        const container = document.getElementById('quiz-container');
        let html = "";
        questions.forEach(q => {
            // Restore from session storage if exists
            const savedAns = sessionStorage.getItem(`ans_${q.id}`) || "";
            
            html += `
                <div class="quiz-item" id="card-${q.id}">
                    <div class="question-header">${q.id}. "${q.ind}"</div>
                    <div class="analysis-text">[Analysis: ${q.anal}]</div>
                    
                    <input type="text" id="input-${q.id}" 
                           placeholder="Type English translation..." 
                           autocomplete="off" 
                           value="${savedAns}"
                           oninput="saveInput(${q.id}, this.value)">
                           
                    <div class="feedback-container" id="feedback-${q.id}">
                        <div id="status-${q.id}" style="font-weight:bold;"></div>
                        <div class="hint-text" id="hint-${q.id}"></div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function saveInput(id, val) {
        sessionStorage.setItem(`ans_${id}`, val);
    }

    function clean(str) { return str.toLowerCase().replace(/[.,?!'"‚Äô]/g, '').replace(/\s+/g, ' ').trim(); }

    function triggerSubmit() { showModal("Submit Answers?", "You cannot change them after this.", "confirm", performSubmit); }

    async function performSubmit() {
        sessionActive = false;
        let score = 0;
        let answersLog = {};

        questions.forEach(q => {
            const inputEl = document.getElementById(`input-${q.id}`);
            const feedbackBox = document.getElementById(`feedback-${q.id}`);
            const statusDiv = document.getElementById(`status-${q.id}`);
            const hintDiv = document.getElementById(`hint-${q.id}`);
            
            const userAns = clean(inputEl.value);
            const correctAns = clean(q.ans);
            let isCorrect = (userAns === correctAns);
            if (!isCorrect && alternateAnswers[q.id]) { if (alternateAnswers[q.id].map(a => clean(a)).includes(userAns)) isCorrect = true; }
            answersLog[`Q${q.id}`] = inputEl.value;
            feedbackBox.style.display = 'block';
            inputEl.disabled = true;

            if (isCorrect) {
                score++; feedbackBox.className = "feedback-container status-correct"; statusDiv.innerHTML = "‚úÖ Correct!"; hintDiv.style.display = 'none';
            } else {
                feedbackBox.className = "feedback-container status-wrong"; statusDiv.innerHTML = "‚ùå Incorrect."; hintDiv.style.display = 'block'; hintDiv.innerHTML = `üí° Hint: ${q.tip}`;
            }
        });

        document.getElementById('submitBtn').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'block';

        const docID = `${studentData.class.replace(/\s/g,'')}_${studentData.no}_${studentData.name.replace(/\s/g,'_')}`;
        await db.collection(COLLECTION_NAME).doc(docID).set({
            name: studentData.name, class: studentData.class, number: studentData.no,
            score: score, total: questions.length, cheat_count: switchCount,
            answers: answersLog, status: "COMPLETED", finish_time: new Date().toLocaleString()
        });

        showModal("Submission Saved!", `You scored ${score}/${questions.length}.`, "alert");
        window.scrollTo({ top: document.getElementById('exercises').offsetTop, behavior: 'smooth' });
    }

    function triggerReset() { showModal("Clear Answers?", "This will reset your score.", "confirm", performReset); }

    function performReset() {
        questions.forEach(q => {
            const input = document.getElementById(`input-${q.id}`);
            const fb = document.getElementById(`feedback-${q.id}`);
            input.value = "";
            input.disabled = false;
            fb.style.display = 'none';
            fb.className = "feedback-container"; 
            sessionStorage.removeItem(`ans_${q.id}`); // Clear auto-save
        });
        document.getElementById('submitBtn').style.display = 'block';
        document.getElementById('resetBtn').style.display = 'none';
        sessionActive = true; 
        window.scrollTo({ top: document.getElementById('exercises').offsetTop, behavior: 'smooth' });
    }

    // --- AGGRESSIVE ANTI-CHEAT ---
    function recordCheat() {
        if (!sessionActive) return;
        if (ignoreBlur) return;
        switchCount++;
        sessionStorage.setItem('cheat_count', switchCount); // Save cheat count too
        document.getElementById('cheat-display').innerText = `OFFENSES: ${switchCount}`;
        const alertBox = document.getElementById('cheat-alert');
        alertBox.style.display = 'block';
        setTimeout(() => alertBox.style.display='none', 3000);
    }
    document.addEventListener("visibilitychange", () => { if (document.hidden) recordCheat(); });
    window.addEventListener("blur", () => { recordCheat(); });

</script>
</body>
</html>
