<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XI TP 2: Final MCQ Assessment</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: var(--text); user-select: none; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        
        h1, h2 { text-align: center; color: var(--primary); margin-bottom: 10px; }
        .btn { display: block; width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1rem; }
        .btn:hover { background: #1d4ed8; }
        
        /* INPUT STYLES */
        input[type="text"], input[type="number"], select { 
            width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; font-size: 1rem; 
        }
        label { font-weight: 600; display: block; margin-bottom: 5px; color: #475569; }

        /* READING PASSAGE */
        .reading-box { 
            background: #fff7ed; border-left: 5px solid #f97316; padding: 15px; 
            margin: 30px 0 10px 0; font-size: 0.95rem; line-height: 1.6; 
            border-radius: 4px; color: #7c2d12; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* QUESTION BOX */
        .question-box { background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 40px; border: 1px solid #e2e8f0; }
        .question-text { font-weight: 700; font-size: 1.05rem; margin-bottom: 15px; line-height: 1.5; color: #1e293b; }
        
        .mcq-label { display: flex; align-items: flex-start; padding: 12px; background: white; border: 1px solid #cbd5e1; margin-top: 8px; border-radius: 6px; cursor: pointer; transition: 0.1s; }
        .mcq-label:hover { border-color: var(--primary); background: #eff6ff; }
        .mcq-input { width: auto !important; margin-right: 12px; margin-top: 4px; transform: scale(1.3); flex-shrink: 0; }

        /* ANTI-CHEAT UI */
        #cheat-alert { background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 8px; display: none; text-align: center; font-weight: bold; position: sticky; top: 10px; z-index: 500; border: 1px solid #c0392b; }
        .cheat-counter { position: fixed; top: 15px; right: 15px; background: #fff; color: #c0392b; padding: 8px 15px; border-radius: 30px; font-size: 0.9rem; font-weight: bold; border: 2px solid #c0392b; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .watermark-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; opacity: 0.04; display: flex; flex-wrap: wrap; overflow: hidden; }
        .watermark-text { transform: rotate(-30deg); margin: 60px; font-weight: 900; font-size: 20px; color: #000; }

        .result-box { text-align: center; padding: 30px; background: #ecfdf5; border: 2px solid var(--success); border-radius: 12px; }
        .wrong-list { margin-top: 20px; color: #dc2626; font-size: 0.95rem; text-align: left; background: white; padding: 15px; border-radius: 8px; border: 1px solid #fecaca; }

        /* WAITING ROOM & LOGIN */
        #waiting-room { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:99999; flex-direction:column; justify-content:center; align-items:center; text-align:center; }
        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#f1f5f9; z-index:20000; display:flex; justify-content:center; align-items:center; }
        .login-box { background:white; padding:30px; border-radius:10px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:90%; max-width:400px; }
        
        #quiz-section { display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body oncontextmenu="return false;">

<div id="global-watermark" class="watermark-overlay"></div>
<div id="cheat-display" class="cheat-counter">OFFENSES: 0</div>
<div id="cheat-alert">‚ö†Ô∏è ALERT: FOCUS LOST! INCIDENT RECORDED.</div>

<div class="container" id="quiz-section">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:bold; border-bottom:2px solid #e2e8f0; padding-bottom:10px;">
        <span>XI Final Assessment</span>
        <span style="color:var(--danger); animation: pulse 2s infinite;">‚óè Live Monitoring</span>
    </div>

    <div id="mcq-container">Loading Questions...</div>
    <button class="btn" onclick="submitFinal()" style="background:var(--success);">Submit Final Answers</button>
</div>

<div id="waiting-room">
    <div style="font-size:4rem;">üîí</div>
    <h1 style="color:#1e293b; margin-bottom:10px;">Waiting for Teacher</h1>
    <p style="color:#64748b; font-size:1.1rem;">Do not refresh. The exam will start automatically.</p>
    <div style="margin-top:20px; width:50px; height:50px; border:5px solid #e2e8f0; border-top:5px solid #2563eb; border-radius:50%; animation:spin 1s linear infinite;"></div>
</div>

<div id="login-overlay" style="display:none;">
    <div class="login-box">
        <h2>XI TP 2 Login</h2>
        <select id="directClass" style="margin-bottom:10px;">
            <option value="">Select Class...</option>
            <option value="XI D">XI D</option>
            <option value="XI E">XI E</option>
            <option value="XI H">XI H</option>
            <option value="XI I">XI I</option>
        </select>
        <input type="number" id="directNo" placeholder="Attendance No." style="margin-bottom:10px;">
        <input type="text" id="directName" placeholder="Full Name" style="margin-bottom:10px;">
        <button class="btn" onclick="directLogin()">Start Exam</button>
    </div>
</div>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097"
    };
    try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){}

    const COLLECTION_NAME = "grade_xi_part2_mcq";
    let currentDocID = null;
    let switchCount = 0;
    let sessionActive = false;
    let userAnswers = {}; 
    let studentData = {};

    // --- LOCK SYSTEM & LOGIN ---
    (function() {
        const wm = document.getElementById('global-watermark');
        let html = ""; for(let i=0; i<40; i++) html += `<div class="watermark-text">MCQ EXAM<br>DO NOT CHEAT</div>`;
        wm.innerHTML = html;

        // Check if student came from index.html
        const examCode = sessionStorage.getItem('exam_code');
        
        if(examCode) {
            // Credentials exist, wait for unlock
            studentData = {
                name: sessionStorage.getItem('student_name'),
                class: sessionStorage.getItem('student_class'),
                no: sessionStorage.getItem('student_no')
            };
            waitForUnlock(examCode);
        } else {
            // Direct access -> Show Login
            document.getElementById('login-overlay').style.display = 'flex';
        }
    })();

    function directLogin() {
        const name = document.getElementById('directName').value;
        const cls = document.getElementById('directClass').value;
        const no = document.getElementById('directNo').value;
        if(!name || !cls || !no) return alert("Fill all fields");
        
        studentData = { name, class: cls, no };
        document.getElementById('login-overlay').style.display = 'none';
        startExamSetup(); // Direct start (bypass lock if accessing directly, or you can add code check here)
    }

    function waitForUnlock(code) {
        document.getElementById('waiting-room').style.display = 'flex';
        // LISTEN TO FIREBASE FOR UNLOCK SIGNAL
        db.collection('active_exam_codes').doc(code).onSnapshot(doc => {
            if(doc.exists && doc.data().status === "UNLOCKED") {
                document.getElementById('waiting-room').style.display = 'none';
                startExamSetup();
            }
        });
    }

    async function startExamSetup() {
        currentDocID = `${studentData.class.replace(/\s/g,'')}_${studentData.no}_${studentData.name.replace(/\s/g,'_')}`;
        
        // CHECK IF ALREADY SUBMITTED
        const docSnap = await db.collection(COLLECTION_NAME).doc(currentDocID).get();
        if(docSnap.exists && docSnap.data().status === "COMPLETED") {
            document.body.innerHTML = "<h1 style='text-align:center; margin-top:50px;'>You have already submitted this exam.</h1>";
            return;
        }

        // INIT OR RESTORE SESSION
        if (docSnap.exists) {
            const data = docSnap.data();
            switchCount = data.cheat_count || 0;
            userAnswers = data.temp_answers || {};
        } else {
            await db.collection(COLLECTION_NAME).doc(currentDocID).set({
                class: studentData.class, number: studentData.no, name: studentData.name,
                start_time: new Date().toLocaleString(),
                status: "IN_PROGRESS",
                cheat_count: 0,
                temp_answers: {}
            });
        }

        renderQuizLayout();
        document.getElementById('quiz-section').style.display = 'block';
        document.getElementById('cheat-display').style.display = 'block';
        document.getElementById('cheat-display').innerText = `OFFENSES: ${switchCount}`;
        
        // DELAY CHEAT DETECTION TO PREVENT INSTANT TRIGGER
        setTimeout(() => { sessionActive = true; }, 2000);
        document.documentElement.requestFullscreen().catch(e=>{});
    }

    // --- READING TEXTS ---
    const TEXT_PASSAGE_1 = `<strong>Passage 1: Mental Health in Elite Sport</strong><br><br>Elite athletes are often viewed as superhumans... [Truncated for brevity, full text in render logic]`;
    const TEXT_PASSAGE_2 = `<strong>Passage 2: Interpreting Physical Education Data</strong><br><br>A recent study tracked 500 high school students... [Truncated for brevity, full text in render logic]`;
    
    // (Full text variable re-declared inside render or kept global - see below for cleaner implementation)
    
    const FULL_TEXT_1 = `<strong>Passage 1: Mental Health in Elite Sport</strong><br><br>Elite athletes are often viewed as superhumans, possessing bodies and minds capable of enduring extreme stress. However, recent events in the sporting world have shone a light on the fragile mental health of these competitors. The pressure to win, combined with intense public scrutiny, can lead to severe anxiety and depression. Unlike in the past, where "toughing it out" was the norm, athletes are now speaking up.<br><br>One major issue is the identity crisis many athletes face. Their self-esteem is often entirely tied to their performance. When they suffer an injury or retire, they lose their sense of belonging and purpose. Furthermore, the constant travel and isolation from family remove their support systems, making them vulnerable. Sports psychologists are now an integral part of coaching teams, teaching coping mechanisms like mindfulness to help athletes maintain their focus and determination without sacrificing their well-being.`;

    const FULL_TEXT_2 = `<strong>Passage 2: Interpreting Physical Education Data</strong><br><br>A recent study tracked 500 high school students to analyze the correlation between physical education (PE) and academic performance. The data, presented in the chart, reveals a clear trend. Students who participated in zero hours of PE per week had the lowest average GPA. As the hours of physical activity increased, so did the students' grades.<br><br>To explain more about that, researchers believe that physical activity stimulates blood flow to the brain and releases endorphins, which improve concentration and memory. However, the data also showed that beyond 7 hours of intense training, grades slightly dipped, likely due to fatigue and lack of study time. This suggests that while exercise is beneficial, balance is key.`;

    const MC_QUESTIONS = [
        {id:1, q:"After weeks of training for the marathon, her ______ finally paid off when she crossed the finish line.", opts:["anxiety","determination","pressure","well-being"], ans:"determination"},
        {id:2, q:"The yoga instructor emphasized being ______ of our breathing to reduce stress.", opts:["physical","mindful","anxious","least"], ans:"mindful"},
        {id:3, q:"Winning the science fair gave him a huge boost in ______, making him feel he could achieve anything.", opts:["self-confidence","attention span","endorphins","depression"], ans:"self-confidence"},
        {id:4, q:"Teenagers often seek a ______ within their peer groups because they want to feel accepted and safe.", opts:["sense of belonging","self-control","pressure","joy"], ans:"sense of belonging"},
        {id:5, q:"Studies show that regular exercise releases ______, which are chemicals in the brain that act as natural painkillers and mood elevators.", opts:["supports","endorphins","anxieties","spans"], ans:"endorphins"},
        {id:6, q:"The constant ______ to succeed in elite sports can sometimes lead to mental burnout.", opts:["joy","well-being","pressure","self-esteem"], ans:"pressure"},
        {id:7, q:"Now that we've discussed the benefits, ______ the potential risks involved.", opts:["let's start by","let's turn to","one reason may be","to explain more about that"], ans:"let's turn to"},
        {id:8, q:"The graph shows a significant rise in sales. ______, the bar chart illustrates a decline in production costs.", opts:["One reason may be","Another way that","To explain more about that","Let's start by"], ans:"Another way that"},
        {id:9, q:"His short ______ made it difficult for him to sit through the two-hour lecture without checking his phone.", opts:["self-control","attention span","well-being","determination"], ans:"attention span"},
        {id:10, q:"______ why the team failed is that they lacked proper communication during the match.", opts:["Let's turn to","One reason may be","Another way that","To explain more about that"], ans:"One reason may be"},
        {id:11, q:"Having high ______ means you generally feel good about your own worth as a person.", opts:["self-esteem","anxiety","pressure","support"], ans:"self-esteem"},
        {id:12, q:"When describing the pie chart, we can see that the 'Rent' section accounts for ______ 40% of the total expenses.", opts:["exactly","roughly","much more","least"], ans:"roughly"},
        {id:13, q:"The doctor was concerned about the patient's general ______, suggesting a better diet and more sleep to improve their health.", opts:["well-being","determination","belonging","self-control"], ans:"well-being"},
        {id:14, q:"______ exercise helps mental health is by reducing levels of stress hormones in the body.", opts:["Let's turn to","Another way that","One reason may be","To explain more about that"], ans:"Another way that"},
        {id:15, q:"Without the ______ of her family and friends, she wouldn't have been able to finish her degree during such a hard time.", opts:["support","pressure","anxiety","depression"], ans:"support"},
        {id:16, q:"The new stadium ______ by the city council next year.", opts:["is built","was built","will be built","has been built"], ans:"will be built"},
        {id:17, q:"This year's exam was ______ difficult than last year's; almost everyone failed.", opts:["much more","little","the least","as"], ans:"much more"},
        {id:18, q:"Of all the runners, she was the ______ exhausted after the race.", opts:["less","most","more","much"], ans:"most"},
        {id:19, q:"English ______ in many countries around the world as a second language.", opts:["speaks","is speaking","is spoken","spoke"], ans:"is spoken"},
        {id:20, q:"That was the ______ interesting movie I have ever seen; I fell asleep twice.", opts:["least","less","most","more"], ans:"least"},
        {id:21, q:"The results ______ to the students by email yesterday.", opts:["are sent","were sent","have been sent","send"], ans:"were sent"},
        {id:22, q:"My new laptop is ______ faster than my old one.", opts:["many","a lot","very","as"], ans:"a lot"},
        {id:23, q:"The problem ______ right now by the technical team.", opts:["is solved","is being solved","was solved","solves"], ans:"is being solved"},
        {id:24, q:"This route is slightly ______ than the one we took yesterday.", opts:["long","longest","longer","the longest"], ans:"longer"},
        {id:25, q:"Many mistakes ______ in the final report, which caused confusion.", opts:["were made","made","are making","have made"], ans:"were made"},
        {id:26, q:"According to the text, why are elite athletes vulnerable to mental health issues?", opts:["They are physically weaker than average people.","They face intense pressure to win and public judgment.","They do not have enough time to train.","They lack determination."], ans:"They face intense pressure to win and public judgment.", passage: FULL_TEXT_1},
        {id:27, q:"What does the phrase 'toughing it out' imply about the past attitude in sports?", opts:["Athletes used to be physically stronger.","Athletes were encouraged to ignore their mental struggles.","Athletes were more open about their feelings.","Athletes preferred tough competitions."], ans:"Athletes were encouraged to ignore their mental struggles.", passage: FULL_TEXT_1},
        {id:28, q:"Why is retirement or injury particularly difficult for elite athletes?", opts:["They lose their financial income immediately.","They lose their sense of identity and belonging.","They have to find new hobbies.","They are no longer famous."], ans:"They lose their sense of identity and belonging.", passage: FULL_TEXT_1},
        {id:29, q:"The text suggests that self-esteem in athletes is often linked to:", opts:["Their family support.","Their physical appearance.","Their performance in their sport.","Their wealth."], ans:"Their performance in their sport.", passage: FULL_TEXT_1},
        {id:30, q:"What role do sports psychologists play now?", opts:["They replace the physical coaches.","They help athletes ignore their emotions.","They teach coping mechanisms like mindfulness.","They manage the athletes' travel schedules."], ans:"They teach coping mechanisms like mindfulness.", passage: FULL_TEXT_1},
        {id:31, q:"What is the main trend shown in the imagined chart described in the text?", opts:["More PE hours generally lead to lower GPAs.","There is no relationship between PE and grades.","More PE hours generally correspond to higher GPAs.","Students who don't exercise have the highest grades."], ans:"More PE hours generally correspond to higher GPAs.", passage: FULL_TEXT_2},
        {id:32, q:"Based on the text, what happens to students who train for more than 7 hours a week?", opts:["Their grades continue to skyrocket.","Their grades slightly decline.","They become professional athletes.","They concentration improves indefinitely."], ans:"Their grades slightly decline.", passage: FULL_TEXT_2},
        {id:33, q:"Which vocabulary phrase is used in the text to introduce a deeper reason for the findings?", opts:["Let's turn to","One reason may be","To explain more about that","Another way that"], ans:"To explain more about that", passage: FULL_TEXT_2},
        {id:34, q:"According to the researchers, why does exercise help academic performance?", opts:["It makes students too tired to misbehave.","It releases endorphins and improves concentration.","It guarantees admission to college.","It reduces the time spent on video games."], ans:"It releases endorphins and improves concentration.", passage: FULL_TEXT_2},
        {id:35, q:"What conclusion does the text draw about exercise?", opts:["It is only for elite athletes.","It is dangerous for students.","Balance is key; too much can be detrimental.","It should replace all academic classes."], ans:"Balance is key; too much can be detrimental.", passage: FULL_TEXT_2},
        {id:36, q:"The word 'correlation' in the text is closest in meaning to:", opts:["Difference","Connection","Problem","Separation"], ans:"Connection", passage: FULL_TEXT_2},
        {id:37, q:"If a student exercises 0 hours a week, their GPA is likely to be:", opts:["The highest in the class.","The lowest among the groups studied.","Exactly 3.0.","Unaffected."], ans:"The lowest among the groups studied.", passage: FULL_TEXT_2},
        {id:38, q:"The text implies that endorphins help with:", opts:["Muscle growth only.","Sleeping patterns.","Memory and concentration.","Social skills."], ans:"Memory and concentration.", passage: FULL_TEXT_2},
        {id:39, q:"The 'dip' in grades after 7 hours is attributed to:", opts:["Lack of interest.","Fatigue and less time to study.","Too many endorphins.","Poor coaching."], ans:"Fatigue and less time to study.", passage: FULL_TEXT_2},
        {id:40, q:"What is the best title for Passage 2?", opts:["Why PE Should Be Banned.","The Dangers of Elite Sport.","The Link Between Physical Activity and Academic Success.","How to Train for a Marathon."], ans:"The Link Between Physical Activity and Academic Success.", passage: FULL_TEXT_2}
    ];

    // --- RENDER ---
    function renderQuizLayout() {
        const contentArea = document.getElementById('mcq-container');
        contentArea.innerHTML = "";
        
        MC_QUESTIONS.forEach(q => {
            if (q.passage) {
                contentArea.innerHTML += `<div class="reading-box">${q.passage}</div>`;
            }

            let optionsHTML = "";
            q.opts.forEach(opt => {
                const isChecked = (userAnswers[`Q${q.id}`] === opt) ? "checked" : "";
                optionsHTML += `
                    <label class="mcq-label">
                        <input type="radio" class="mcq-input" name="q_${q.id}" value="${opt}" ${isChecked} onchange="saveProgress('Q${q.id}', '${opt}')">
                        <span>${opt}</span>
                    </label>`;
            });

            contentArea.innerHTML += `
                <div class="question-box">
                    <div class="question-text">${q.id}. ${q.q}</div>
                    ${optionsHTML}
                </div>`;
        });
    }

    function saveProgress(qKey, value) {
        userAnswers[qKey] = value;
        db.collection(COLLECTION_NAME).doc(currentDocID).update({ temp_answers: userAnswers }, { merge: true });
    }

    async function submitFinal() {
        sessionActive = false; // Disable cheat tracking for submit process
        if(!confirm("Are you sure? You cannot change answers after submitting.")) {
            sessionActive = true; return; // Cancelled
        }
        
        let correctCount = 0;
        let wrongList = [];

        MC_QUESTIONS.forEach(q => {
            if(userAnswers[`Q${q.id}`] === q.ans) correctCount++;
            else wrongList.push(q.id);
        });

        let rawScore = Math.round((correctCount / 30) * 100);
        
        await db.collection(COLLECTION_NAME).doc(currentDocID).update({
            status: "COMPLETED",
            finish_time: new Date().toLocaleString(),
            final_score: rawScore,
            correct_count: correctCount,
            wrong_list: wrongList,
            final_cheat_count: switchCount
        });

        document.body.innerHTML = `
            <div class="container">
                <div class="result-box">
                    <h1 style="color:var(--success)">Assessment Submitted</h1>
                    <div style="font-size:3rem; font-weight:bold; margin:20px 0;">${rawScore}</div>
                    <p>Score based on 30 items (Bonus applied).</p>
                    <hr>
                    <p><strong>Total Correct:</strong> ${correctCount} / 40</p>
                    
                    <div class="wrong-list">
                        <strong>Missed Questions:</strong><br>
                        ${wrongList.length > 0 ? wrongList.join(", ") : "Perfect Score!"}
                    </div>
                </div>
                <button class="btn" onclick="location.reload()" style="background:#64748b; margin-top:20px;">Close Exam</button>
            </div>
        `;
    }

    // --- STRICT ANTI-CHEAT ---
    function recordCheat() {
        if (!sessionActive) return;
        switchCount++;
        document.getElementById('cheat-display').innerText = `OFFENSES: ${switchCount}`;
        const alertBox = document.getElementById('cheat-alert');
        alertBox.style.display = 'block';
        setTimeout(() => alertBox.style.display='none', 3000);
        db.collection(COLLECTION_NAME).doc(currentDocID).update({ cheat_count: switchCount });
    }

    document.addEventListener("visibilitychange", () => { if (document.hidden) recordCheat(); });
    window.addEventListener("blur", () => { recordCheat(); });

</script>
</body>
</html>
