<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week 23: Urban Transition & Impersonal Language</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --white: #ffffff; --success: #27ae60; --danger: #c0392b; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: var(--primary); background-color: var(--bg); margin: 0; padding: 20px; user-select: none; }
        
        /* LOGIN & SECURITY UI */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .login-box select, .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .btn-login { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-login:hover { background: #2980b9; }

        #cheat-alert { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(192, 57, 43, 0.95); color: white; z-index: 20000; display: none; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
        #cheat-counter { position: fixed; top: 10px; right: 10px; background: white; padding: 5px 15px; border-radius: 20px; border: 2px solid var(--danger); color: var(--danger); font-weight: bold; font-family: sans-serif; display: none; z-index: 9000; }

        /* MAIN CONTENT (Hidden initially) */
        .container { max-width: 900px; margin: 0 auto; background: var(--white); padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: none; }
        
        h1, h2 { color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 40px; }
        .reading-box { background: #fffaf0; padding: 25px; border-left: 5px solid #f39c12; border-radius: 4px; font-style: normal; margin-bottom: 20px; }
        
        .word-bank { display: flex; flex-wrap: wrap; gap: 10px; background: #eef7ff; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px dashed var(--accent); }
        .word-item { background: var(--white); padding: 5px 12px; border-radius: 15px; border: 1px solid var(--accent); font-size: 0.9em; font-weight: bold; }
        
        .exercise-row { margin-bottom: 15px; display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap; }
        input[type="text"] { border: none; border-bottom: 2px solid #ccc; padding: 5px; font-size: 1em; width: 250px; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-bottom-color: var(--accent); background: #f0f8ff; }
        
        .grammar-guide { background: #fdf2f2; padding: 20px; border-radius: 8px; border-left: 5px solid #e74c3c; margin: 20px 0; }
        .impersonal-row { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .original-text { font-style: italic; color: #666; margin-bottom: 5px; }

        .btn-check { background: var(--success); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; font-size: 1.1rem; width: 100%; transition: 0.2s; }
        .btn-check:hover { background: #219150; }
        
        #final-status { text-align: center; font-size: 1.5rem; font-weight: bold; margin-top: 20px; padding: 20px; border-radius: 8px; display: none; }
        .receipt { font-size: 0.9rem; color: #7f8c8d; font-family: monospace; margin-top: 5px; display: block; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body oncontextmenu="return false;">

    <div id="cheat-alert">
        <div style="font-size: 5rem;">⚠️</div>
        <h1>FOCUS LOST</h1>
        <p>This incident has been recorded.</p>
        <button onclick="dismissCheatAlert()" style="padding: 10px 20px; font-size: 1.2rem; border: none; background: white; color: var(--danger); font-weight: bold; cursor: pointer; border-radius: 6px; margin-top: 20px;">I'm Back</button>
    </div>

    <div id="cheat-counter">OFFENSES: 0</div>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:20px;">Week 23 Assessment</h2>
            
            <select id="sClass" onchange="loadStudents()">
                <option value="">Select Class...</option>
                <option value="XI D">XI D</option>
                <option value="XI E">XI E</option>
                <option value="XI H">XI H</option>
                <option value="XI I">XI I</option>
            </select>
            
            <input type="text" id="sNameInput" list="student-list" placeholder="Search your name..." disabled>
            <datalist id="student-list"></datalist>

            <button class="btn-login" onclick="attemptLogin()">Start Assessment</button>
            <p id="error-msg" style="color: red; display: none; margin-top: 10px; font-size: 0.9rem;">Please select valid details.</p>
        </div>
    </div>

    <div class="container" id="main-content">
        <h1>Part 1: Reading Comprehension</h1>
        <div class="reading-box">
            <h3>The Great Urban Transition</h3>
            <p>In his formative years, Elias lived in a small, rural village, but as he reached adulthood, his ambition led him to a sprawling <strong>conurbation</strong> that seemed to vanish into the horizon. Like many others, he had been <strong>uprooted</strong> from his quiet life because the local fossil fuels plant had closed, forcing him to seek a more <strong>sustainable</strong> future in the city.</p>
            <p>However, Elias quickly realized that the intended dream of city life came with significant challenges. He was met with extreme <strong>congestion</strong>, a direct result of decades of uncontrolled <strong>urban sprawl</strong>. Despite these issues, there was a <strong>consensus</strong> among the citizens that the city remained a vital center for cultural identity and economic expansion.</p>
            <p>Elias found work in a high-security firm specializing in <strong>cryptography</strong>. His daily tasks involved developing a new <strong>algorithm</strong> to ensure the <strong>verification</strong> of digital signatures. In an era where hackers constantly try to <strong>intercept</strong> data, keeping information <strong>confidential</strong> was a matter of national security. He spent hours analyzing the differences between symmetric vs. <strong>asymmetric</strong> encryption.</p>
            <p>One such project involved the <strong>contamination</strong> of the city’s aquatic systems. There is believed to be a link between the old industrial zones and the rising levels of toxins in the water. To summarize the crisis: without immediate investment in new <strong>infrastructure</strong> and <strong>innovation</strong>, the city's growth would no longer be viable.</p>
        </div>

        <p><em>Task: Write down any unknown words from the text and their meanings in your notebook.</em></p>

        <h2>Part 2: Vocabulary Practice</h2>
        <div class="word-bank">
            <span class="word-item">Algorithm</span> <span class="word-item">Asymmetric</span> <span class="word-item">Confidential</span>
            <span class="word-item">Congestion</span> <span class="word-item">Contamination</span> <span class="word-item">Conurbation</span>
            <span class="word-item">Cryptography</span> <span class="word-item">Despite</span> <span class="word-item">Formative Years</span> 
            <span class="word-item">Infrastructure</span> <span class="word-item">Innovation</span> <span class="word-item">Intercept</span> 
            <span class="word-item">Put Down Roots</span> <span class="word-item">Sensible</span> <span class="word-item">Skeptical</span> 
            <span class="word-item">Sustainable</span> <span class="word-item">Uprooted</span> <span class="word-item">Urban Sprawl</span>
        </div>

        <div id="vocab-exercise">
            <div class="exercise-row">1. The small village was eventually absorbed into a massive <input type="text" data-ans="conurbation"> as the cities merged.</div>
            <div class="exercise-row">2. He spent his <input type="text" data-ans="formative years"> in a quiet coastal town.</div>
            <div class="exercise-row">3. The government is <input type="text" data-ans="skeptical"> about the new economic plan.</div>
            <div class="exercise-row">4. After years of traveling, she decided to <input type="text" data-ans="put down roots"> in London.</div>
            <div class="exercise-row">5. Hackers attempted to <input type="text" data-ans="intercept"> the transmission of banking data.</div>
            <div class="exercise-row">6. The city's rapid <input type="text" data-ans="urban sprawl"> has led to loss of habitats.</div>
            <div class="exercise-row">7. <input type="text" data-ans="despite"> the heavy rain, the concert continued.</div>
            <div class="exercise-row">8. In <input type="text" data-ans="asymmetric"> encryption, two different keys are used.</div>
            <div class="exercise-row">9. The community was <input type="text" data-ans="uprooted"> when the new dam project flooded their lands.</div>
            <div class="exercise-row">10. Heavy traffic <input type="text" data-ans="congestion"> has become a daily struggle.</div>
        </div>

        <h2>Part 3: Impersonal Language</h2>
        <div class="grammar-guide">
            <strong>Grammar Tip:</strong> To sound more formal and objective, we use impersonal structures: <br>
            <code>It + is + [Passive Verb] + that + [Clause]</code> <br>
            <em>Example: "People say..." &rarr; "It is said that..."</em>
        </div>

       <div id="grammar-section">
            <div class="impersonal-row"><div class="original-text">1. Scientists believe that the evolution of AI will change the job market.</div><input type="text" data-ans="It is believed that the evolution of AI will change the job market."></div>
            <div class="impersonal-row"><div class="original-text">2. Citizens report that urban sprawl is destroying the local forest.</div><input type="text" data-ans="It is reported that urban sprawl is destroying the local forest."></div>
            <div class="impersonal-row"><div class="original-text">3. Financial analysts suggest that the infrastructure project will cost billions.</div><input type="text" data-ans="It is suggested that the infrastructure project will cost billions."></div>
            <div class="impersonal-row"><div class="original-text">4. Witnesses claim that the hacker tried to intercept the private email.</div><input type="text" data-ans="It is claimed that the hacker tried to intercept the private email."></div>
            <div class="impersonal-row"><div class="original-text">5. Experts assume that cryptography will become even more complex.</div><input type="text" data-ans="It is assumed that cryptography will become even more complex."></div>
            <div class="impersonal-row"><div class="original-text">6. Many people think that his formative years in exile influenced his poetry.</div><input type="text" data-ans="It is thought that his formative years in exile influenced his poetry."></div>
            <div class="impersonal-row"><div class="original-text">7. Researchers know that contamination in the river is rising.</div><input type="text" data-ans="It is known that contamination in the river is rising."></div>
            <div class="impersonal-row"><div class="original-text">8. Engineers expect that the new algorithm will solve the traffic issues.</div><input type="text" data-ans="It is expected that the new algorithm will solve the traffic issues."></div>
            <div class="impersonal-row"><div class="original-text">9. Critics argue that the government’s new policy is not sustainable.</div><input type="text" data-ans="It is argued that the government’s new policy is not sustainable."></div>
            <div class="impersonal-row"><div class="original-text">10. Doctors say that it is sensible to sleep at least eight hours a day.</div><input type="text" data-ans="It is said that it is sensible to sleep at least eight hours a day."></div>
            <div class="impersonal-row"><div class="original-text">11. Observers note that the conurbation is growing toward the mountains.</div><input type="text" data-ans="It is noted that the conurbation is growing toward the mountains."></div>
            <div class="impersonal-row"><div class="original-text">12. Historians believe that the tribe was uprooted during the Great War.</div><input type="text" data-ans="It is believed that the tribe was uprooted during the Great War."></div>
            <div class="impersonal-row"><div class="original-text">13. The board members understand that the data must remain confidential.</div><input type="text" data-ans="It is understood that the data must remain confidential."></div>
            <div class="impersonal-row"><div class="original-text">14. Economists estimate that the innovation will boost the city's productivity.</div><input type="text" data-ans="It is estimated that the innovation will boost the city's productivity."></div>
            <div class="impersonal-row"><div class="original-text">15. Residents complain that traffic congestion is getting worse every month.</div><input type="text" data-ans="It is complained that traffic congestion is getting worse every month."></div>
            <div class="impersonal-row"><div class="original-text">16. Some people feel that it is difficult to put down roots in such a busy city.</div><input type="text" data-ans="It is felt that it is difficult to put down roots in such a busy city."></div>
            <div class="impersonal-row"><div class="original-text">17. Public records show that the company failed to maintain safety standards.</div><input type="text" data-ans="It is shown that the company failed to maintain safety standards."></div>
            <div class="impersonal-row"><div class="original-text">18. Tech experts confirm that asymmetric encryption is the safest method.</div><input type="text" data-ans="It is confirmed that asymmetric encryption is the safest method."></div>
            <div class="impersonal-row"><div class="original-text">19. Philosophers suggest that cultural identity is constantly changing.</div><input type="text" data-ans="It is suggested that cultural identity is constantly changing."></div>
            <div class="impersonal-row"><div class="original-text">20. Critics argue that the CEO remains skeptical of the new technology.</div><input type="text" data-ans="It is argued that the CEO remains skeptical of the new technology."></div>
        </div>

        <button class="btn-check" id="submitBtn" onclick="submitExam()">Submit All Exercises</button>
        <div id="final-status"></div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097"
    };
    try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){}

    const COLLECTION_NAME = "week23urbantransition";
    let cheatCount = 0;
    let sessionActive = false;
    let currentDocID = null;
    let wakeLock = null;

    // --- STUDENT DATABASE (Same as previous) ---
    const studentDB = {
        "XI D": [
            {n:1, name:"Annita"}, {n:2, name:"Arshavince Zenji Milano"}, {n:3, name:"Ashwini Dewan"}, {n:4, name:"Carissa Evelynna Susanto"}, {n:5, name:"Carlin Fayola"},
            {n:6, name:"Celine Elaine Cen"}, {n:7, name:"Celine Siera Winnata"}, {n:8, name:"Derick Ferdinand"}, {n:9, name:"Ella"}, {n:10, name:"Erich Novaro"},
            {n:11, name:"Felix Fernando Ang"}, {n:12, name:"Filbert Suciokto"}, {n:13, name:"Fiona Yozuki"}, {n:14, name:"Fleishia Allyce Ng"}, {n:15, name:"Florencia Melanie Nauli"},
            {n:16, name:"Gabriella Callista Lokman"}, {n:17, name:"Giselle Lee"}, {n:18, name:"Givon"}, {n:19, name:"Goldy Pacific Sun"}, {n:20, name:"Grace Kelly Ignacia"},
            {n:21, name:"Idellia Antoneta"}, {n:22, name:"James Willard Chen"}, {n:23, name:"Janice Giselle Lim"}, {n:24, name:"Javier Chiuman"}, {n:25, name:"Jessica Sachi"},
            {n:26, name:"Jessica Tanji"}, {n:27, name:"Jocelyn Princess Yangklyn"}, {n:28, name:"Joe Kusanagi"}, {n:29, name:"Joice Kwan"}, {n:30, name:"Jose Ferguson Tjong"},
            {n:31, name:"Justin Kwok"}, {n:32, name:"Kendrick Wiliston"}, {n:33, name:"Kenrick Ciuanta"}, {n:34, name:"Kusumo Wijaya"}, {n:35, name:"Lorenzo Alvaro"},
            {n:36, name:"Luis Fernando Gober"}, {n:37, name:"Marcus Hubert Tandyan"}, {n:38, name:"Michelle Patricia Susanto"}, {n:39, name:"Nico Wiman"}, {n:40, name:"Reegan Gunawan"},
            {n:41, name:"Richard Ansle"}, {n:42, name:"Roschella Teisha Widalkho"}, {n:43, name:"Stella Keyne"}, {n:44, name:"Valencia Khosasih"}, {n:45, name:"Wendy Salim"},
            {n:46, name:"Louis Chow"}, {n:47, name:"Valerian Lieandro"}
        ],
        "XI E": [
            {n:1, name:"Angela Sudargo"}, {n:2, name:"Aurellia Fidelya"}, {n:3, name:"Beltiana Lie"}, {n:4, name:"Calvin Khangriawan Tony"}, {n:5, name:"Cathryna Audree Livi"},
            {n:6, name:"Chen Jian Ping"}, {n:7, name:"Cheryl Quinn Mc Cane"}, {n:8, name:"Christopher Lionel Richie"}, {n:9, name:"Cindy Tanaka"}, {n:10, name:"Clairine Vanessa"},
            {n:11, name:"Clara Fiorentina"}, {n:12, name:"Clarise Vincella Tho"}, {n:13, name:"Cynthia Kwan"}, {n:14, name:"Darren Alexius Wijaya"}, {n:15, name:"Ethan Chainito"},
            {n:16, name:"Eunice Yueen"}, {n:17, name:"Evellyn Viorene Khoo"}, {n:18, name:"Evelyn Serenity Tandy"}, {n:19, name:"Federico Oswald"}, {n:20, name:"Filberth Wu"},
            {n:21, name:"Hans Goldhy"}, {n:22, name:"Joyce Dominique"}, {n:23, name:"Joylynn Devanie Conrad"}, {n:24, name:"Justin Adelio Sunvier"}, {n:25, name:"Lolyson Deevan"},
            {n:26, name:"Nicholas Sebastian Tandiono"}, {n:27, name:"Nicole Violetta Tjeong"}, {n:28, name:"Revalyn"}, {n:29, name:"Rogelio Carrick Ang"}, {n:30, name:"Sava Tania"},
            {n:31, name:"Shane Marvin Halim"}, {n:32, name:"Shareen Theodora"}, {n:33, name:"Sherlince Starlene Chandra"}, {n:34, name:"Sophie Aurelia Joycelin"}, {n:35, name:"Stevany Yulia Pratama"},
            {n:36, name:"Sunrio Adinugroho"}, {n:37, name:"Sutanto Owen Liem"}, {n:38, name:"Thesha Bellina Vicjy"}, {n:39, name:"Torres Yang"}, {n:40, name:"Valencia Richel Ongso"},
            {n:41, name:"Vallerie Liecardo"}, {n:42, name:"Vanessa"}, {n:43, name:"Vanessa Lois"}, {n:44, name:"Vicenzo Alfredo"}, {n:45, name:"Vincent Alvarez Zhuo"},
            {n:46, name:"Vincent Wijaya"}, {n:47, name:"Wilbert Lieandy"}, {n:48, name:"Winston Hudson Otteo"}
        ],
        "XI H": [
            {n:1, name:"Aurencia Lievianna"}, {n:2, name:"Carlyn Tanclyn"}, {n:3, name:"Clara Auryn Icasia"}, {n:4, name:"Fayola Aretha Lai"}, {n:5, name:"Grace Angeline Wirjawan"},
            {n:6, name:"Javerlyn Queenicia Chandra"}, {n:7, name:"Jeankelly Samudra Tjuaja"}, {n:8, name:"Joice Kellen"}, {n:9, name:"Jose Fernando"}, {n:10, name:"Justine Tania Chandra"},
            {n:11, name:"Karen Julia Haspan"}, {n:12, name:"Kelsey Valerie Lin"}, {n:13, name:"Kynthia Callysta"}, {n:14, name:"Leonly Geraldine"}, {n:15, name:"Louis Gabriel"},
            {n:16, name:"Louis Thomson"}, {n:17, name:"Madelyn Arcadia Chen"}, {n:18, name:"Mervin Sutiono"}, {n:19, name:"Michael Jhonson"}, {n:20, name:"Michelle"},
            {n:21, name:"Michelle Margareth Cheong"}, {n:22, name:"Nicholas Yang"}, {n:23, name:"Nicole Zasen Yau"}, {n:24, name:"Philips Cuanata"}, {n:25, name:"Revanko Devalim Sunanto"},
            {n:26, name:"Richard Gani"}, {n:27, name:"Robin Surya Toka"}, {n:28, name:"Roschelly Teisha Widalkho"}, {n:29, name:"Sanny"}, {n:30, name:"Sauri Yap Bella"},
            {n:31, name:"Selly Alicia"}, {n:32, name:"Sharon Valerie Widjaja"}, {n:33, name:"Silvia Lim"}, {n:34, name:"Steven"}, {n:35, name:"Stevi Yulia Pratam"},
            {n:36, name:"Tysdeny Tan"}, {n:37, name:"Valerie Tio"}, {n:38, name:"Velin Alicia"}, {n:39, name:"Vicelia Joanna Lie"}, {n:40, name:"Victor Kosasih"},
            {n:41, name:"Whizley Chen"}, {n:42, name:"William Utama"}, {n:43, name:"Willy"}, {n:44, name:"Veda Arsa Iwanto"}
        ],
        "XI I": [
            {n:1, name:"Carlos Valentino Wenrich"}, {n:2, name:"Clareen Cia"}, {n:3, name:"Edward Kennedy Lim"}, {n:4, name:"Gricherry Khonata"}, {n:5, name:"Hazel Robett Can"},
            {n:6, name:"Jasmine Winaka"}, {n:7, name:"Jaycent Fritz Reevesen"}, {n:8, name:"Jessica Evangeli Tjiawijaya"}, {n:9, name:"Joeven"}, {n:10, name:"Joevito Jonathan"},
            {n:11, name:"Jolin Jolicia Ciang"}, {n:12, name:"Kaetlyn Onglicia"}, {n:13, name:"Kaylie Rusli"}, {n:14, name:"Kerich Juin Utama"}, {n:15, name:"Marcelline Metsuko Humutowo"},
            {n:16, name:"Marvennoto Suvega"}, {n:17, name:"Michelle Teresia Sutanto"}, {n:18, name:"Nicholas Valentino"}, {n:19, name:"Owen Chiuman"}, {n:20, name:"Qrin Tanaka"},
            {n:21, name:"Rachel Chandler"}, {n:22, name:"Raymond Filbert Salim"}, {n:23, name:"Renzzo Cedric Guovandry"}, {n:24, name:"Richardo Anderson Halim"}, {n:25, name:"Richardo William"},
            {n:26, name:"Richie Jericho Prince"}, {n:27, name:"Richie Prince Ten"}, {n:28, name:"Ruyi Sun Moon"}, {n:29, name:"Ryanna Nicole Leung"}, {n:30, name:"Sandra Evelyn Limber"},
            {n:31, name:"Shanty Fidella Fu"}, {n:32, name:"Sky Lim"}, {n:33, name:"Sony Fernando Limber"}, {n:34, name:"Stancio Wunand"}, {n:35, name:"Syerena Tania Susanto"},
            {n:36, name:"Valerina Florensia"}, {n:37, name:"Vallentino"}, {n:38, name:"Victoria Huang"}, {n:39, name:"Vincent"}, {n:40, name:"Vincent Alexander Colin"},
            {n:41, name:"Werly"}
        ]
    };

    // --- POPULATE SEARCHABLE LIST ---
    function loadStudents() {
        const cls = document.getElementById('sClass').value;
        const nameInput = document.getElementById('sNameInput');
        const dataList = document.getElementById('student-list');
        
        nameInput.value = ""; 
        dataList.innerHTML = ""; 

        if (cls && studentDB[cls]) {
            nameInput.disabled = false;
            nameInput.focus();
            studentDB[cls].forEach(s => {
                const option = document.createElement('option');
                option.value = s.name; 
                dataList.appendChild(option);
            });
        } else {
            nameInput.disabled = true;
        }
    }

    // --- LOGIN LOGIC ---
    async function attemptLogin() {
        const cls = document.getElementById('sClass').value;
        const enteredName = document.getElementById('sNameInput').value;
        const errorEl = document.getElementById('error-msg');

        if(!cls || !enteredName) {
            errorEl.style.display = 'block';
            return;
        }

        const validStudent = studentDB[cls].find(s => s.name === enteredName);
        if (!validStudent) {
            errorEl.innerText = "Invalid Name. Select from list.";
            errorEl.style.display = 'block';
            return;
        }

        // INIT DB
        currentDocID = `${cls.replace(/\s/g,'')}_${validStudent.n}_${enteredName.replace(/\s/g,'_')}`;
        const docSnap = await db.collection(COLLECTION_NAME).doc(currentDocID).get();

        if(docSnap.exists) {
            cheatCount = docSnap.data().cheat_count || 0;
            if(docSnap.data().status === "COMPLETED") {
                alert("Assessment already completed.");
            }
        } else {
            await db.collection(COLLECTION_NAME).doc(currentDocID).set({
                name: enteredName, class: cls, number: validStudent.n,
                start_time: new Date().toLocaleString(),
                status: "STARTED",
                cheat_count: 0
            });
        }

        // SHOW CONTENT
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('cheat-counter').style.display = 'block';
        document.getElementById('cheat-counter').innerText = `OFFENSES: ${cheatCount}`;

        requestWakeLock();
        setTimeout(() => { sessionActive = true; }, 2000);
        document.documentElement.requestFullscreen().catch(e=>{});
    }

    // --- WAKE LOCK ---
    async function requestWakeLock() {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            });
        } catch (err) { console.log(err); }
    }

    // --- SUBMISSION ---
    async function submitExam() {
        if(!confirm("Submit answers? This cannot be undone.")) return;
        sessionActive = false;

        let inputs = document.querySelectorAll('input[type="text"]:not(#sNameInput)');
        let correctCount = 0;
        let answersLog = {};

        inputs.forEach((input, index) => {
            let userVal = input.value.trim().toLowerCase().replace(/[.!?]$/, "");
            let correctVal = input.getAttribute('data-ans').toLowerCase().replace(/[.!?]$/, "");
            
            answersLog[`Q${index+1}`] = input.value;
            input.disabled = true;

            if (userVal === correctVal) {
                correctCount++;
                // Local feedback disabled for blind submission style (Optional)
                input.style.borderBottomColor = "var(--success)";
                input.style.color = "var(--success)";
            } else {
                input.style.borderBottomColor = "var(--danger)";
                input.style.color = "var(--danger)";
            }
        });

        // HIDE SUBMIT, SHOW RESULT
        document.getElementById('submitBtn').style.display = 'none';
        const status = document.getElementById('final-status');
        const finishTime = new Date().toLocaleString();
        
        status.style.display = 'block';
        status.style.backgroundColor = '#ecfdf5';
        status.style.border = '2px solid #27ae60';
        status.style.color = '#2c3e50';
        status.innerHTML = `
            Submission Received<br>
            <span class="receipt">Score: ${correctCount}/${inputs.length}</span><br>
            <span class="receipt">Time: ${finishTime}</span>
        `;
        window.scrollTo(0,0);

        // SAVE DB
        await db.collection(COLLECTION_NAME).doc(currentDocID).update({
            score: correctCount,
            answers: answersLog,
            status: "COMPLETED",
            finish_time: finishTime,
            submittedAt_timestamp: Date.now(),
            final_cheat_count: cheatCount
        });
    }

    // --- ANTI-CHEAT ---
    function triggerCheat() {
        if (!sessionActive) return;
        cheatCount++;
        document.getElementById('cheat-counter').innerText = `OFFENSES: ${cheatCount}`;
        document.getElementById('cheat-alert').style.display = 'flex';
        
        if(currentDocID) {
            db.collection(COLLECTION_NAME).doc(currentDocID).update({ cheat_count: cheatCount });
        }
    }

    function dismissCheatAlert() {
        document.getElementById('cheat-alert').style.display = 'none';
    }

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'hidden') triggerCheat();
    });

    window.addEventListener("blur", () => {
        triggerCheat();
    });

</script>
</body>
</html>
