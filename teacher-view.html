<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher View: Writing Assessment</title>
    <style>
        :root { --primary: #c44569; --bg: #f7f1e3; --white: #ffffff; --text: #2f3542; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e1e24; display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; width: 300px; }
        input { padding: 10px; width: 100%; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        button:hover { background: #b03a5b; }

        /* DASHBOARD */
        #dashboard { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .header h1 { margin: 0; color: var(--primary); font-size: 1.5rem; }

        /* DATA TABLE */
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th, td { padding: 15px; border-bottom: 1px solid #dfe4ea; }
        th { background: #f1f2f6; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; color: #57606f; }
        tr:hover { background: #f1f2f6; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        
        .preview-text { color: #555; font-style: italic; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle; }

        /* READER MODAL */
        #detail-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto; padding: 30px; border-radius: 12px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close-btn { position: absolute; top: 15px; right: 15px; background: #dfe4ea; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        
        .report-box { background: #f1f2f6; padding: 20px; border-radius: 8px; border-left: 5px solid var(--primary); font-family: 'Georgia', serif; line-height: 1.6; font-size: 1.1rem; color: #2f3542; white-space: pre-wrap; margin-top: 15px; }
        .meta-info { font-size: 0.9rem; color: #747d8c; margin-bottom: 5px; }

    </style>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Teacher Access</h2>
            <input type="password" id="pinInput" placeholder="Enter PIN (030)">
            <button onclick="checkLogin()">Login</button>
        </div>
    </div>

    <div id="dashboard">
        <div class="header">
            <div>
                <h1>üïµÔ∏è Detective Reports (Writing)</h1>
                <p style="color:#747d8c; margin:5px 0 0 0;">Collection: <code style="background:#eee; padding:2px 5px; border-radius:4px;">week23xii_critical</code></p>
            </div>
            <div>
                <button onclick="loadData()" style="width:auto; margin-right:10px; background:#747d8c;">üîÑ Refresh</button>
                <button onclick="downloadCSV()" style="width:auto; background:#059669;">üì• Download Excel</button>
            </div>
        </div>

        <div class="card">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Name</th>
                        <th>Cheats</th>
                        <th>Time Taken</th>
                        <th>Report Preview</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" style="text-align:center;">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="detail-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">√ó</button>
            <h2 id="modal-title">Student Name</h2>
            <div class="meta-info" id="modal-meta">Class | Time</div>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            <div id="modal-body" class="report-box"></div>
        </div>
    </div>

<script>
    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097"
    };
    try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){}

    const COLLECTION_NAME = "week23xii_critical"; // Targeting the WRITING collection
    let allData = [];

    function checkLogin() {
        if(document.getElementById('pinInput').value === "030") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadData();
        } else {
            alert("Wrong PIN");
        }
    }

    async function loadData() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Fetching reports...</td></tr>';
        
        try {
            const snap = await db.collection(COLLECTION_NAME).orderBy('class').get();
            allData = []; 
            tbody.innerHTML = '';

            if (snap.empty) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No reports found.</td></tr>';
                return;
            }

            snap.forEach(doc => {
                const d = doc.data();
                d.id = doc.id; 
                allData.push(d);

                const row = document.createElement('tr');
                
                // Cheat Badge
                const cheats = d.final_cheat_count || d.cheat_count || 0;
                const cheatBadge = cheats > 0 
                    ? `<span class="badge badge-red">${cheats} Offenses</span>` 
                    : `<span class="badge badge-green">Clean</span>`;

                // Calculate Time Taken (15m - Remaining)
                let timeTaken = "N/A";
                if (d.time_remaining !== undefined) {
                    const used = 900 - d.time_remaining;
                    const m = Math.floor(used / 60);
                    const s = used % 60;
                    timeTaken = `${m}m ${s}s`;
                }

                // Essay Preview (First 50 chars)
                const fullText = d.essay_answer || "(No text submitted)";
                const preview = fullText.length > 50 ? fullText.substring(0, 50) + "..." : fullText;

                row.innerHTML = `
                    <td><strong>${d.class}</strong></td>
                    <td>${d.name}<br><small style="color:#999">#${d.number}</small></td>
                    <td>${cheatBadge}</td>
                    <td>${timeTaken}</td>
                    <td><span class="preview-text">${preview}</span></td>
                    <td><button onclick="viewDetails('${d.id}')" style="padding:6px 12px; font-size:0.85rem; width:auto; background:#c44569; color:white; border:none; border-radius:4px; cursor:pointer;">üëÅÔ∏è Read Report</button></td>
                `;
                tbody.appendChild(row);
            });

        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">Error: ${error.message}</td></tr>`;
        }
    }

    function viewDetails(docId) {
        const student = allData.find(s => s.id === docId);
        if (!student) return;

        document.getElementById('modal-title').innerText = student.name;
        
        let timeInfo = student.finish_time ? `Submitted: ${student.finish_time}` : "In Progress";
        document.getElementById('modal-meta').innerText = `${student.class} (#${student.number}) | ${timeInfo}`;
        
        const text = student.essay_answer || "No text submitted.";
        document.getElementById('modal-body').innerText = text;

        document.getElementById('detail-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('detail-modal').style.display = 'none';
    }

    // --- CSV DOWNLOADER ---
    function downloadCSV() {
        if (allData.length === 0) return alert("No data to download.");

        let csv = "Class,Number,Name,Cheats,Time_Finished,Full_Essay_Report\n";

        allData.forEach(d => {
            // Clean text for CSV (remove newlines and quotes)
            let essay = (d.essay_answer || "").replace(/"/g, '""').replace(/\n/g, " ");
            
            const cheats = d.final_cheat_count ?? d.cheat_count ?? 0;
            const time = d.finish_time || "";

            csv += `${d.class},${d.number},"${d.name}",${cheats},"${time}","${essay}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", "Week23_Critical_Thinking_Reports.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
