<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher View: Week 23 XII</title>
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; --white: #ffffff; --text: #1f2937; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111827; display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; width: 300px; }
        input { padding: 10px; width: 100%; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        button:hover { background: #4338ca; }

        /* DASHBOARD */
        #dashboard { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .header h1 { margin: 0; color: var(--primary); }

        /* DATA TABLE */
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th, td { padding: 15px; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; color: #6b7280; }
        tr:hover { background: #f9fafb; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-gray { background: #f3f4f6; color: #374151; }

        /* MODAL */
        #detail-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 25px; border-radius: 12px; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: #e5e7eb; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        
        .answer-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .answer-key { font-weight: bold; color: #6b7280; }
        .answer-val { color: #111827; font-family: monospace; font-size: 1.1em; }

    </style>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Teacher Access</h2>
            <input type="password" id="pinInput" placeholder="Enter PIN (030)">
            <button onclick="checkLogin()">Login</button>
        </div>
    </div>

    <div id="dashboard">
        <div class="header">
            <div>
                <h1>üìä Submissions: Week 23 Exercise</h1>
                <p style="color:#6b7280; margin:5px 0 0 0;">Collection: <code style="background:#eee; padding:2px 5px; border-radius:4px;">week23exercisexii</code></p>
            </div>
            <div>
                <button onclick="loadData()" style="width:auto; margin-right:10px; background:#6b7280;">üîÑ Refresh</button>
                <button onclick="downloadCSV()" style="width:auto; background:#059669;">üì• Download Excel</button>
            </div>
        </div>

        <div class="card">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Cheats</th>
                        <th>Time</th>
                        <th>Input</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" style="text-align:center;">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="detail-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">√ó</button>
            <h2 id="modal-title">Student Answers</h2>
            <div id="modal-body"></div>
        </div>
    </div>

<script>
    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097"
    };
    try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){}

    const COLLECTION_NAME = "week23exercisexii"; // Specifically requested
    let allData = [];

    function checkLogin() {
        if(document.getElementById('pinInput').value === "030") {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadData();
        } else {
            alert("Wrong PIN");
        }
    }

    async function loadData() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Fetching...</td></tr>';
        
        try {
            const snap = await db.collection(COLLECTION_NAME).orderBy('class').get();
            allData = []; // Reset local cache
            tbody.innerHTML = '';

            if (snap.empty) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No submissions found in <strong>' + COLLECTION_NAME + '</strong></td></tr>';
                return;
            }

            snap.forEach(doc => {
                const d = doc.data();
                d.id = doc.id; // Save ID
                allData.push(d);

                const row = document.createElement('tr');
                
                // Cheat Badge Logic
                const cheats = d.cheat_count || 0;
                const cheatBadge = cheats > 0 
                    ? `<span class="badge badge-red">${cheats} Offenses</span>` 
                    : `<span class="badge badge-green">Clean</span>`;

                // Score Logic
                const score = d.final_score !== undefined ? d.final_score : (d.score !== undefined ? d.score : "-");

                row.innerHTML = `
                    <td><strong>${d.class}</strong></td>
                    <td>${d.name}<br><small style="color:#999">#${d.number}</small></td>
                    <td><span class="badge badge-gray" style="font-size:1em;">${score}</span></td>
                    <td>${cheatBadge}</td>
                    <td style="font-size:0.85rem; color:#666;">${d.finish_time || d.submittedAt || "In Progress"}</td>
                    <td><button onclick="viewDetails('${d.id}')" style="padding:5px 10px; font-size:0.8rem; width:auto; background:#6366f1;">üëÅÔ∏è View</button></td>
                `;
                tbody.appendChild(row);
            });

        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">Error loading data: ${error.message}</td></tr>`;
        }
    }

    function viewDetails(docId) {
        const student = allData.find(s => s.id === docId);
        if (!student) return;

        document.getElementById('modal-title').innerText = `${student.name} (${student.class})`;
        const body = document.getElementById('modal-body');
        body.innerHTML = '';

        // 1. Check for "answers" object (from Exercise)
        if (student.answers) {
            Object.keys(student.answers).sort().forEach(key => {
                const val = student.answers[key];
                body.innerHTML += `
                    <div class="answer-row">
                        <span class="answer-key">${key.toUpperCase()}</span>
                        <span class="answer-val">${val}</span>
                    </div>`;
            });
        } 
        // 2. Check for "essay_answer" (from Critical Thinking)
        else if (student.essay_answer) {
            body.innerHTML += `<div style="background:#f9fafb; padding:15px; border-radius:8px; line-height:1.6;">${student.essay_answer}</div>`;
        }
        // 3. Fallback
        else {
            body.innerHTML = '<p style="color:#666;">No specific input data found.</p>';
        }

        document.getElementById('detail-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('detail-modal').style.display = 'none';
    }

    // --- CSV DOWNLOADER ---
    function downloadCSV() {
        if (allData.length === 0) return alert("No data to download.");

        let csv = "Class,Number,Name,Score,Cheats,Time,Inputs\n";

        allData.forEach(d => {
            // Flatten answers into a string
            let inputStr = "";
            if(d.answers) inputStr = JSON.stringify(d.answers).replace(/,/g, '|').replace(/"/g, "'");
            else if(d.essay_answer) inputStr = d.essay_answer.replace(/\n/g, ' ').replace(/,/g, ';');

            const score = d.final_score ?? d.score ?? 0;
            const cheats = d.cheat_count ?? 0;
            const time = d.finish_time || d.submittedAt || "";

            csv += `${d.class},${d.number},"${d.name}",${score},${cheats},"${time}","${inputStr}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", "Week23_XII_Results.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
