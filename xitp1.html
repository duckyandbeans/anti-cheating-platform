<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XI TP 1: Graph Analysis</title>
    <style>
        :root { --primary: #7c3aed; --bg: #f5f3ff; --text: #1f2937; --danger: #ef4444; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: var(--text); user-select: none; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        h1, h2 { text-align: center; color: var(--primary); margin-bottom: 10px; }
        .btn { display: block; width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1rem; }
        .btn:hover { background: #6d28d9; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        /* GRAPHS */
        .graph-container { text-align: center; margin-bottom: 20px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 8px; }
        .graph-img { width: 100%; max-width: 250px; border: 1px solid #ccc; margin: 5px; border-radius: 4px; display: inline-block; transition: transform 0.2s; }
        .graph-img:hover { transform: scale(1.5); border-color: var(--primary); z-index: 10; position: relative; }

        /* CAMERA */
        .camera-box { width: 100%; max-width: 500px; margin: 20px auto; background: black; border-radius: 8px; overflow: hidden; position: relative; }
        video { width: 100%; display: block; }
        
        /* PHOTO GRID */
        .photo-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
        .photo-card { position: relative; width: 150px; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; background: white; }
        .photo-card img { width: 100%; height: 200px; object-fit: cover; display: block; }
        .delete-btn { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(220, 38, 38, 0.9); color: white; border: none; padding: 5px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        /* ANTI-CHEAT */
        #cheat-alert { background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 8px; display: none; text-align: center; font-weight: bold; position: sticky; top: 10px; z-index: 500; border: 1px solid #c0392b; }
        .cheat-counter { position: fixed; top: 15px; right: 15px; background: #fff; color: #c0392b; padding: 8px 15px; border-radius: 30px; font-size: 0.9rem; font-weight: bold; border: 2px solid #c0392b; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .watermark-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; opacity: 0.04; display: flex; flex-wrap: wrap; overflow: hidden; }
        .watermark-text { transform: rotate(-30deg); margin: 60px; font-weight: 900; font-size: 20px; color: #000; }

        /* WAITING ROOM */
        #waiting-room { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#f8fafc; z-index:99999; flex-direction:column; justify-content:center; align-items:center; text-align:center; }
        .waiting-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px; width: 90%; }
        .spinner { margin: 20px auto; width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top: 5px solid #7c3aed; border-radius: 50%; animation: spin 1s linear infinite; }
        .status-badge { background: #fee2e2; color: #991b1b; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; margin-top: 15px; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body oncontextmenu="return false;">

<div id="global-watermark" class="watermark-overlay"></div>
<div id="cheat-display" class="cheat-counter">OFFENSES: 0</div>
<div id="cheat-alert">‚ö†Ô∏è ALERT: FOCUS LOST! INCIDENT RECORDED.</div>

<div class="container">
    <div id="exam-header" style="text-align:center; margin-bottom:20px;">
        <h1>XI TP 1: Graph Analysis</h1>
        <p style="color:#6b7280;">Upload your handwritten essay.</p>
    </div>

    <div class="graph-container">
        <h3>Reference Material</h3>
        <p style="font-size:0.9rem; color:#666;">(Hover/Tap to Zoom)</p>
        <img src="1.png" class="graph-img" alt="Graph 1">
        <img src="2.png" class="graph-img" alt="Graph 2">
        <img src="3.png" class="graph-img" alt="Graph 3">
    </div>

    <hr style="margin:20px 0; border:0; border-top:1px solid #ddd;">

    <h3>üì∑ Scan Your Work</h3>
    <p style="text-align:center; margin-bottom:10px;">Ensure text is readable. Max 6 pages.</p>
    
    <div class="camera-box"><video id="videoFeed" autoplay playsinline></video></div>
    <canvas id="canvas" style="display:none;"></canvas>
    
    <button class="btn" id="snapBtn" onclick="takeSnapshot()" style="background:#374151; width:auto; margin:10px auto;">üì∏ Capture Page</button>
    <div id="photo-limit-msg" style="text-align:center; color:red; display:none; margin-top:10px;">Maximum 6 pages reached!</div>
    
    <div class="photo-grid" id="photoGallery"></div>
    <button class="btn" id="submitBtn" onclick="submitFinal()" style="background:green; margin-top:40px;">Submit All Pages</button>
</div>

<div id="waiting-room">
    <div class="waiting-card">
        <div style="font-size:3rem;">üîí</div>
        <h2 style="color:#1f2937; margin-bottom:5px;">Exam Locked</h2>
        <p style="color:#6b7280; margin-bottom:20px;">Waiting for teacher to start...</p>
        
        <div class="spinner"></div>
        
        <div id="statusText" class="status-badge" style="background:#fef3c7; color:#d97706;">Connecting...</div>
        <div style="margin-top:20px; font-size:0.85rem; color:#9ca3af;">Do not refresh the page.</div>
        <button onclick="window.location.href='index.html'" style="margin-top:20px; background:none; border:none; color:#7c3aed; text-decoration:underline; cursor:pointer;">Exit / Wrong Code</button>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097"
    };
    try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){}

    const COLLECTION_NAME = "grade_xi_part1_essay";
    let currentDocID = null;
    let switchCount = 0;
    let sessionActive = false;
    let essayPages = [];
    let studentData = {};

    function initWatermark() {
        const wm = document.getElementById('global-watermark');
        let html = ""; for(let i=0; i<40; i++) html += `<div class="watermark-text">ESSAY EXAM<br>DO NOT CHEAT</div>`;
        wm.innerHTML = html;
    }
    initWatermark();

    // --- LOCK SYSTEM ---
    (function() {
        const examCode = sessionStorage.getItem('exam_code');
        const statusText = document.getElementById('statusText');
        const waitScreen = document.getElementById('waiting-room');

        if(!examCode) { window.location.href = 'index.html'; return; }

        waitScreen.style.display = 'flex';
        
        // Listen to the SPECIFIC code document
        db.collection('active_exam_codes').doc(examCode).onSnapshot(doc => {
            if (!doc.exists) {
                statusText.style.background = "#fee2e2";
                statusText.style.color = "#dc2626";
                statusText.innerText = "‚ùå Invalid / Expired Code";
            } else if (doc.data().status === "UNLOCKED") {
                waitScreen.style.display = 'none';
                initializeExam();
            } else {
                statusText.style.background = "#dcfce7";
                statusText.style.color = "#166534";
                statusText.innerText = "‚úÖ Connected to Room";
            }
        }, err => {
            statusText.innerText = "‚ö†Ô∏è Connection Error";
        });
    })();

    async function initializeExam() {
        // Retrieve credentials from Index
        const cls = sessionStorage.getItem('student_class');
        const no = sessionStorage.getItem('student_no');
        const name = sessionStorage.getItem('student_name');
        
        currentDocID = `${cls.replace(/\s/g,'')}_${no}_${name.replace(/\s/g,'_')}`;
        studentData = { class: cls, number: no, name: name };

        // Check Previous Session
        const docRef = db.collection(COLLECTION_NAME).doc(currentDocID);
        const docSnap = await docRef.get();

        if (docSnap.exists) {
            const data = docSnap.data();
            if(data.status === "COMPLETED") {
                document.body.innerHTML = "<h1 style='text-align:center; margin-top:50px;'>Exam Already Submitted</h1>";
                return;
            }
            switchCount = data.cheat_count || 0;
            if (data.essay_pages) { essayPages = data.essay_pages; renderGallery(); }
        } else {
            await docRef.set({
                class: cls, number: no, name: name,
                start_time: new Date().toLocaleString(),
                status: "IN_PROGRESS",
                cheat_count: 0,
                essay_pages: []
            });
        }

        document.getElementById('cheat-display').style.display='block';
        document.getElementById('cheat-display').innerText = `OFFENSES: ${switchCount}`;
        startCamera();
        sessionActive = true; 
        document.documentElement.requestFullscreen().catch(e=>{});
    }

    // --- CAMERA & LOGIC ---
    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(s => document.getElementById('videoFeed').srcObject = s)
            .catch(e => {
                navigator.mediaDevices.getUserMedia({ video: true })
                .then(s => document.getElementById('videoFeed').srcObject = s);
            });
    }

    function takeSnapshot() {
        if(essayPages.length >= 6) return;
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('canvas');
        const scale = 800 / video.videoWidth;
        canvas.width = 800; canvas.height = video.videoHeight * scale;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        essayPages.push(canvas.toDataURL('image/jpeg', 0.6));
        db.collection(COLLECTION_NAME).doc(currentDocID).update({ essay_pages: essayPages });
        renderGallery();
    }

    function renderGallery() {
        const gallery = document.getElementById('photoGallery');
        gallery.innerHTML = "";
        essayPages.forEach((src, idx) => {
            gallery.innerHTML += `<div class="photo-card"><img src="${src}"><button class="delete-btn" onclick="deletePhoto(${idx})">üóëÔ∏è Delete Page ${idx+1}</button></div>`;
        });
        const snapBtn = document.getElementById('snapBtn');
        const limitMsg = document.getElementById('photo-limit-msg');
        if (essayPages.length >= 6) { snapBtn.disabled = true; snapBtn.style.background = "#ccc"; limitMsg.style.display = 'block'; }
        else { snapBtn.disabled = false; snapBtn.style.background = "#374151"; limitMsg.style.display = 'none'; }
    }

    function deletePhoto(index) {
        if(!confirm("Delete this page?")) return;
        essayPages.splice(index, 1);
        db.collection(COLLECTION_NAME).doc(currentDocID).update({ essay_pages: essayPages });
        renderGallery();
    }

    async function submitFinal() {
        if(essayPages.length === 0) return alert("Take at least one photo.");
        if(!confirm(`Submit ${essayPages.length} pages?`)) return;
        sessionActive = false;
        await db.collection(COLLECTION_NAME).doc(currentDocID).update({ status: "COMPLETED", finish_time: new Date().toLocaleString(), final_cheat_count: switchCount });
        document.body.innerHTML = `<div class="container" style="text-align:center;"><h1 style="color:green;">Submitted!</h1><p>You may close this tab.</p></div>`;
    }

    // --- AGGRESSIVE ANTI-CHEAT ---
    function recordCheat() {
        if (!sessionActive) return;
        switchCount++;
        document.getElementById('cheat-display').innerText = `OFFENSES: ${switchCount}`;
        const alertBox = document.getElementById('cheat-alert');
        alertBox.style.display = 'block';
        setTimeout(() => alertBox.style.display='none', 3000);
        db.collection(COLLECTION_NAME).doc(currentDocID).update({ cheat_count: switchCount });
    }
    document.addEventListener("visibilitychange", () => { if (document.hidden) recordCheat(); });
    window.addEventListener("blur", () => { recordCheat(); });

</script>
</body>
</html>
