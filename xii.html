<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade XII Assessment + Answer Key</title>
    <style>
        :root { --primary: #4f46e5; --danger: #ef4444; --success: #10b981; --bg: #f3f4f6; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            padding: 20px; 
            color: #1f2937;
            -webkit-user-select: none; user-select: none;
        }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #111827; }
        .btn { display: block; width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1rem;}
        .btn:hover { background: #4338ca; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box;}

        .question-box { margin-bottom: 30px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; position: relative; }
        .question-text { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; }
        
        .mcq-label { display: block; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; background: white; }
        .mcq-label:hover { background: #eff6ff; border-color: var(--primary); }
        .mcq-input { margin-right: 10px; }
        .mcq-input:checked + span { font-weight: bold; color: var(--primary); }

        .word-bank { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; min-height: 40px; padding: 10px; background: #eee; border-radius: 6px; }
        .answer-area { min-height: 50px; border-bottom: 2px dashed #4f46e5; display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; align-items: center; background: #fff; }
        .word-chip { background: white; border: 1px solid #ccc; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-weight: 500; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .word-chip.used { opacity: 0.3; pointer-events: none; background: #ddd; }
        .word-chip-answer { background: var(--primary); color: white; border: none; padding: 5px 12px; border-radius: 20px; cursor: pointer; }

        /* REVIEW STYLES */
        .review-card { padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc; }
        .review-correct { background-color: #d1fae5; border-color: #10b981; } /* Green */
        .review-wrong { background-color: #fee2e2; border-color: #ef4444; } /* Red */
        .correct-answer-text { color: #047857; font-weight: bold; margin-top: 5px; font-size: 0.9rem; }

        #cheat-alert { background: #fee2e2; border: 1px solid #f87171; color: #991b1b; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; display: none; text-align: center; font-weight: bold; position: sticky; top: 10px; z-index: 100; }
        .watermark-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; opacity: 0.04; display: flex; flex-wrap: wrap; overflow: hidden; }
        .watermark-text { transform: rotate(-30deg); margin: 50px; font-weight: 900; font-size: 20px; }
        .info-box { background: #e0f2fe; border: 1px solid #bae6fd; color: #0369a1; padding: 15px; border-radius: 6px; font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px; }

        #login-section, #system-check-section, #quiz-section, #teacher-section { display: none; }
        #login-section { display: block; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body oncontextmenu="return false;">

<div id="global-watermark" class="watermark-overlay"></div>

<div class="container">
    <div id="cheat-alert">‚ö†Ô∏è ALERT: Screen switch detected!</div>

    <div id="login-section">
        <h1>XII Assessment Login</h1>
        
        <label>Class</label>
        <select id="studentClass">
            <option value="">Select Class...</option>
            <option value="XII H">XII H</option>
            <option value="XII I">XII I</option>
        </select>
        <label>Attendance Number</label>
        <input type="number" id="studentNo" placeholder="e.g. 15">
        <label>Full Name</label>
        <input type="text" id="studentName" placeholder="Enter your full name">

        <button class="btn" onclick="verifyLogin()">Next</button>
    </div>

    <div id="system-check-section">
        <h1>‚öôÔ∏è System Check</h1>
        <div class="info-box">
            <strong>‚ö†Ô∏è EXAM RULES:</strong><br><br>
            1. <strong>Do Not Switch Tabs:</strong> It will be recorded as cheating.<br>
            2. <strong>Stay Full Screen:</strong> Do not minimize the browser.<br>
            3. <strong>Honesty is Integrity.</strong>
        </div>
        <div id="confirm-area" style="margin-top:20px;">
            <input type="checkbox" id="rulesCheck" onchange="document.getElementById('startBtn').disabled = !this.checked">
            <label for="rulesCheck">I understand the rules and am ready to start.</label>
            <button class="btn" id="startBtn" onclick="startQuiz()" disabled>START QUIZ</button>
        </div>
    </div>

    <div id="quiz-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">English Test</h2>
            <div style="color:red; font-weight:bold; font-size:0.9rem;">‚óè REC</div>
        </div>
        <form id="quiz-form"><div id="quiz-container"></div></form>
        <button class="btn" id="submitBtn" onclick="submitExam()">Submit Exam</button>
    </div>

    <div id="teacher-section">
        <h1>üë©‚Äçüè´ Teacher Dashboard</h1>
        <button class="btn" onclick="downloadExcel()">üì• Download Report (.csv)</button>
        <button class="btn" onclick="location.reload()" style="background:#666; margin-top:10px;">Log Out</button>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAB_on0WAobEXccxHvcwtS9ShxQpfATH-A",
      authDomain: "anti-cheating-remedial-quiz.firebaseapp.com",
      projectId: "anti-cheating-remedial-quiz",
      storageBucket: "anti-cheating-remedial-quiz.firebasestorage.app",
      messagingSenderId: "979294386230",
      appId: "1:979294386230:web:7f9ff3e377d4da20cd4097"
    };
    try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){}

    // --- VARIABLES ---
    const COLLECTION_NAME = "grade_xii_grammar_final"; 
    let currentDocID = null;
    let switchCount = 0;
    let sessionActive = false;

    // --- QUIZ DATA ---
    const QUIZ_SOURCE = {
        "multiple_choice": [
            { "id": 1, "question": "The burglar _____ by the time the police finally arrived.", "options": ["fled", "was fleeing", "had fled", "has fled"], "answer": "had fled" },
            { "id": 2, "question": "I _____ to the news on the radio when I heard a loud crash.", "options": ["listened", "was listening", "have listened", "had listened"], "answer": "was listening" },
            { "id": 3, "question": "She realized she _____ her wallet at home when she reached the checkout counter.", "options": ["left", "has left", "had left", "was leaving"], "answer": "had left" },
            { "id": 4, "question": "I _____ for the bus when I saw my old friend from college.", "options": ["waited", "was waiting", "had waited", "have waited"], "answer": "was waiting" },
            { "id": 5, "question": "The storm _____ outside while we sat comfortably by the fire.", "options": ["raged", "was raging", "had raged", "has raged"], "answer": "was raging" },
            { "id": 6, "question": "She was annoyed because she _____ for two hours when he finally arrived.", "options": ["waited", "has been waiting", "had been waiting", "was waiting"], "answer": "had been waiting" },
            { "id": 7, "question": "The music _____ by the time we entered the concert hall.", "options": ["stopped", "was stopping", "had stopped", "has stopped"], "answer": "had stopped" },
            { "id": 8, "question": "He was exhausted because he _____ in the garden all day.", "options": ["worked", "has worked", "had been working", "was working"], "answer": "had been working" },
            { "id": 9, "question": "I didn't go to the movie with them because I _____ it before.", "options": ["saw", "was seeing", "had seen", "have seen"], "answer": "had seen" },
            { "id": 10, "question": "It _____ to rain just as we stepped out of the house.", "options": ["began", "was beginning", "had begun", "has begun"], "answer": "began" },
            { "id": 11, "question": "They _____ in that house for 20 years before they decided to sell it.", "options": ["lived", "were living", "have lived", "had been living"], "answer": "had been living" },
            { "id": 12, "question": "The roads were slippery because it _____ all night.", "options": ["rained", "was raining", "has rained", "had been raining"], "answer": "had been raining" },
            { "id": 13, "question": "What _____ before you came here?", "options": ["did you do", "were you doing", "had you been doing", "have you done"], "answer": "had you been doing" },
            { "id": 14, "question": "By the time he was thirty, he _____ three best-selling books.", "options": ["wrote", "was writing", "had written", "has written"], "answer": "had written" },
            { "id": 15, "question": "She _____ the piano for ten years before her first public concert.", "options": ["played", "was playing", "had been playing", "has played"], "answer": "had been playing" },
            { "id": 16, "question": "He _____ to the audience when the fire alarm suddenly went off.", "options": ["spoke", "was speaking", "had spoken", "has spoken"], "answer": "was speaking" },
            { "id": 17, "question": "She _____ such a beautiful view until that moment on the mountain.", "options": ["never saw", "did not see", "had never seen", "was never seeing"], "answer": "had never seen" },
            { "id": 18, "question": "I _____ him for years before we met again at the reunion.", "options": ["knew", "was knowing", "had known", "had been knowing"], "answer": "had known" },
            { "id": 19, "question": "I _____ to call you yesterday, but I completely forgot.", "options": ["meant", "was meaning", "had meant", "mean"], "answer": "meant" },
            { "id": 20, "question": "The company _____ well for years before the sudden bankruptcy.", "options": ["worked", "was working", "has worked", "had been working"], "answer": "had been working" },
            { "id": 21, "question": "Every summer, we _____ go to the beach for a week.", "options": ["did", "would", "were", "had"], "answer": "would" },
            { "id": 22, "question": "I _____ like spinach when I was young, but now I love it.", "options": ["didn't use to", "didn't used to", "wouldn't", "don't use to"], "answer": "didn't use to" },
            { "id": 23, "question": "Did you _____ have long hair when you were a teenager?", "options": ["use to", "used to", "using", "use"], "answer": "use to" },
            { "id": 24, "question": "My grandma _____ always bake cookies on Sundays.", "options": ["used", "would", "was", "did"], "answer": "would" },
            { "id": 25, "question": "In the evenings, he _____ write letters to his friends abroad.", "options": ["used", "was", "had", "would"], "answer": "would" },
            { "id": 26, "question": "It was the first time I _____ sushi.", "options": ["ate", "was eating", "had eaten", "have eaten"], "answer": "had eaten" },
            { "id": 27, "question": "The band _____ on stage when the lights suddenly went out.", "options": ["performed", "were performing", "had performed", "have performed"], "answer": "were performing" },
            { "id": 28, "question": "The sun _____ and the birds were singing as we set off.", "options": ["shone", "was shining", "had shone", "shines"], "answer": "was shining" },
            { "id": 29, "question": "When I arrived at the office, the meeting _____.", "options": ["finished", "was finishing", "has finished", "had finished"], "answer": "had finished" },
            { "id": 30, "question": "I _____ about moving for a long time before I finally did it.", "options": ["thought", "was thinking", "have thought", "had been thinking"], "answer": "had been thinking" }
        ],
        "sentence_building": [
            { "id": 31, "scrambled": ["used", "to", "He", "play", "football", "every", "weekend"], "correct_order": "He used to play football every weekend" },
            { "id": 32, "scrambled": ["had", "been", "She", "working", "all", "day"], "correct_order": "She had been working all day" },
            { "id": 33, "scrambled": ["would", "We", "visit", "grandma", "often", "very"], "correct_order": "We would visit grandma very often" }
        ]
    };

    // --- LOGIC ---
    function generateWatermark() {
        const wm = document.getElementById('global-watermark');
        let html = "";
        for(let i=0; i<50; i++) html += `<div class="watermark-text">${i%2?"HONESTY":"INTEGRITY"}</div>`;
        wm.innerHTML = html;
    }
    generateWatermark();

    function verifyLogin() {
        const name = document.getElementById('studentName').value;
        const no = document.getElementById('studentNo').value;
        const cls = document.getElementById('studentClass').value;
        
        if(name === "030" && no === "0" && cls === "") {
            document.getElementById('login-section').style.display='none';
            document.getElementById('teacher-section').style.display='block';
            return;
        }

        if(!name || !no || !cls) return alert("Please fill in all details.");
        currentDocID = `${cls}_${no}_${name.replace(/\s/g,'_')}`;
        document.getElementById('login-section').style.display='none';
        document.getElementById('system-check-section').style.display='block';
    }

    async function startQuiz() {
        const name = document.getElementById('studentName').value;
        const no = document.getElementById('studentNo').value;
        const cls = document.getElementById('studentClass').value;
        
        await db.collection(COLLECTION_NAME).doc(currentDocID).set({
            name: name, number: no, class: cls,
            start_time: new Date().toLocaleString(),
            status: "IN_PROGRESS", cheat_count: 0
        });

        renderQuiz();
        document.getElementById('system-check-section').style.display='none';
        document.getElementById('quiz-section').style.display='block';
        document.documentElement.requestFullscreen().catch(e=>{});
        sessionActive = true;
    }

    function renderQuiz() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = "";
        
        // A. MCQ
        container.innerHTML += `<h3>Part A: Multiple Choice</h3>`;
        QUIZ_SOURCE.multiple_choice.forEach((q, idx) => {
            let optionsHTML = "";
            q.options.forEach(opt => {
                optionsHTML += `<label class="mcq-label"><input type="radio" class="mcq-input" name="mcq_${q.id}" value="${opt}"><span>${opt}</span></label>`;
            });
            container.innerHTML += `<div class="question-box"><div class="question-text">${idx+1}. ${q.question}</div>${optionsHTML}</div>`;
        });

        // B. SENTENCE
        container.innerHTML += `<h3>Part B: Arrange the Sentences</h3>`;
        QUIZ_SOURCE.sentence_building.forEach((q, idx) => {
            container.innerHTML += `
                <div class="question-box" id="sb_container_${q.id}">
                    <div class="question-text">${idx+1}. Arrange the words:</div>
                    <div class="word-bank" id="bank_${q.id}">
                        ${q.scrambled.map(word => `<div class="word-chip" onclick="moveWord(${q.id}, '${word.replace(/'/g, "\\'")}', this)">${word}</div>`).join('')}
                    </div>
                    <div class="question-text" style="font-size:0.9rem; color:#666;">Your Answer (Click to remove):</div>
                    <div class="answer-area" id="ans_${q.id}"></div>
                    <input type="hidden" name="sb_${q.id}" id="input_sb_${q.id}">
                </div>`;
        });
    }

    window.moveWord = function(qId, word, element) {
        if(element.classList.contains('used')) return;
        element.classList.add('used');
        const ansArea = document.getElementById(`ans_${qId}`);
        const chip = document.createElement('div');
        chip.className = 'word-chip-answer';
        chip.innerText = word;
        chip.onclick = function() {
            ansArea.removeChild(chip);
            element.classList.remove('used');
            updateHiddenInput(qId);
        };
        ansArea.appendChild(chip);
        updateHiddenInput(qId);
    }

    function updateHiddenInput(qId) {
        const ansArea = document.getElementById(`ans_${qId}`);
        const words = Array.from(ansArea.children).map(c => c.innerText);
        document.getElementById(`input_sb_${qId}`).value = words.join(" ");
    }

    async function submitExam() {
        if(!confirm("Submit Exam?")) return;
        sessionActive = false;
        let score = 0;
        let answers = {};

        QUIZ_SOURCE.multiple_choice.forEach(q => {
            const val = (document.querySelector(`input[name="mcq_${q.id}"]:checked`) || {}).value || "";
            answers[`Q${q.id}`] = val;
            if(val === q.answer) score++;
        });

        QUIZ_SOURCE.sentence_building.forEach(q => {
            const val = document.getElementById(`input_sb_${q.id}`).value;
            answers[`SB_${q.id}`] = val;
            if(val === q.correct_order) score++;
        });

        await db.collection(COLLECTION_NAME).doc(currentDocID).update({
            status: "COMPLETED", finish_time: new Date().toLocaleString(),
            score: score, all_answers: answers, final_cheat_count: switchCount
        });

        // --- NEW: GENERATE ANSWER KEY REPORT ---
        let reviewHTML = "";
        
        // Review MCQ
        QUIZ_SOURCE.multiple_choice.forEach((q, idx) => {
            const userAns = answers[`Q${q.id}`];
            const isCorrect = userAns === q.answer;
            const cssClass = isCorrect ? "review-correct" : "review-wrong";
            const icon = isCorrect ? "‚úÖ" : "‚ùå";
            
            reviewHTML += `
                <div class="review-card ${cssClass}">
                    <div><strong>${idx + 1}. ${q.question}</strong></div>
                    <div>Your Answer: ${userAns || "(No Answer)"} ${icon}</div>
                    ${!isCorrect ? `<div class="correct-answer-text">Correct Answer: ${q.answer}</div>` : ""}
                </div>
            `;
        });

        // Review Sentence Builder
        QUIZ_SOURCE.sentence_building.forEach((q, idx) => {
            const userAns = answers[`SB_${q.id}`];
            const isCorrect = userAns === q.correct_order;
            const cssClass = isCorrect ? "review-correct" : "review-wrong";
            const icon = isCorrect ? "‚úÖ" : "‚ùå";

            reviewHTML += `
                <div class="review-card ${cssClass}">
                    <div><strong>${idx + 31}. Arrange Sentence</strong></div>
                    <div>Your Answer: ${userAns || "(No Answer)"} ${icon}</div>
                    ${!isCorrect ? `<div class="correct-answer-text">Correct Order: ${q.correct_order}</div>` : ""}
                </div>
            `;
        });

        document.body.innerHTML = `
            <div class="container">
                <h1 style="color:green">Submission Complete!</h1>
                <h2 style="text-align:center;">Final Score: ${score} / 33</h2>
                <hr>
                <h3>Review Your Answers:</h3>
                ${reviewHTML}
                <button class="btn" onclick="location.reload()" style="background:#666;">Close / Log Out</button>
            </div>
        `;
    }

    document.addEventListener("visibilitychange", () => {
        if(document.hidden && sessionActive) {
            switchCount++;
            document.getElementById('cheat-alert').style.display='block';
            document.getElementById('cheat-alert').innerText = `‚ö†Ô∏è ALERT: Tab Switch #${switchCount}`;
            db.collection(COLLECTION_NAME).doc(currentDocID).update({cheat_count: switchCount});
        }
    });

    async function downloadExcel() {
        const snap = await db.collection(COLLECTION_NAME).get();
        let csv = "data:text/csv;charset=utf-8,Class,Number,Name,Score,Cheats,Answers\n";
        snap.forEach(doc => {
            const d = doc.data();
            csv += `${d.class},${d.number},"${d.name}",${d.score},${d.cheat_count},"${JSON.stringify(d.all_answers||{}).replace(/"/g,"'")}"\n`;
        });
        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = "XII_Quiz_Report.csv";
        document.body.appendChild(link);
        link.click();
    }
</script>
</body>
</html>
